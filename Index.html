<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="images/apple-icon-180.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMR MARDAN</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="/manifest.json">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRious for QR Code Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- reCAPTCHA v3 (Site key placeholder ke saath) -->
    <script src="https://www.google.com/recaptcha/api.js?render=YOUR_RECAPTCHA_SITE_KEY"></script>
    <style>
        /* Inter font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
            text-align: left;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Custom colors for a vibrant app feel */
        .bg-primary { background-color: #1E3A8A; } /* Dark Blue */
        .text-primary { color: #1E3A8A; }
        .border-primary { border-color: #1E3A8A; }
        .hover\:bg-primary-darker:hover { background-color: #152C6A; } /* Slightly darker blue */
        .bg-green-main { background-color: #116530; } /* Deep Green */
        .text-green-main { color: #116530; }
        .hover\:bg-green-darker:hover { background-color: #0A4A22; } /* Slightly darker green */

        /* Card specific styles */
        .app-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .app-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        /* Collapsible section styling */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #e0e7ff; /* Light blue for headers */
            border-bottom: 1px solid #c3dafe;
            border-radius: 0.75rem; /* Rounded corners for headers */
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #1E3A8A;
            transition: background-color 0.2s ease-in-out;
        }
        .collapsible-header:hover {
            background-color: #c3dafe;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1rem; /* Add horizontal padding */
        }
        .collapsible-content.active {
            max-height: 1000px; /* Adjust as needed for content height */
            padding-bottom: 1rem; /* Add bottom padding when active */
        }
        .collapsible-header .arrow-icon {
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-header.active .arrow-icon {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center py-8 px-4 md:px-8">

    <!-- Main Container -->
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-6xl border border-primary">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-primary mb-8 leading-tight">
            SMR MARDAN
        </h1>

        <!-- PWA Install Prompt Banner -->
        <div id="installBanner" class="bg-indigo-600 text-white p-4 rounded-lg shadow-lg mb-6 flex items-center justify-between flex-wrap hidden">
            <div class="flex items-center">
                <i class="fas fa-mobile-alt text-2xl mr-3"></i>
                <p class="font-semibold text-lg">Install SMR MARDAN App!</p>
            </div>
            <button id="installButton" class="bg-white text-indigo-700 hover:bg-indigo-100 font-bold py-2 px-4 rounded-full shadow-md transition duration-300 ease-in-out mt-3 md:mt-0">
                Install Now
            </button>
            <button onclick="hideInstallBanner()" class="ml-2 text-white hover:text-gray-200 text-xl transition duration-300 ease-in-out">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Login/Registration Section -->
        <div id="authSection" class="bg-gray-100 p-6 rounded-xl shadow-inner mb-6">
            <h2 class="text-2xl font-bold text-primary mb-4 text-center">Login or Register to Access Full Features</h2>
            <p class="text-center text-gray-700 mb-6">Login and register to benefit from the app and help make SMR better.</p>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-gray-700 font-semibold mb-2">Email:</label>
                    <input type="email" id="loginEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-gray-700 font-semibold mb-2">Password:</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="********" required>
                </div>
                <button type="submit" class="w-full bg-primary hover:bg-primary-darker text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
                <p class="text-center text-gray-600 mt-4">Don't have an account? <a href="#" id="showRegisterFormLink" class="text-primary hover:underline font-semibold">Register Here</a></p>
            </form>

            <form id="registerForm" class="space-y-4 hidden">
                <div>
                    <label for="registerEmail" class="block text-gray-700 font-semibold mb-2">Email:</label>
                    <input type="email" id="registerEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="registerPassword" class="block text-gray-700 font-semibold mb-2">Password:</label>
                    <input type="password" id="registerPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="********" required>
                </div>
                <div>
                    <label for="confirmPassword" class="block text-gray-700 font-semibold mb-2">Confirm Password:</label>
                    <input type="password" id="confirmPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="********" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-user-plus mr-2"></i> Register
                </button>
                <p class="text-center text-gray-600 mt-4">Already have an account? <a href="#" id="showLoginFormLink" class="text-primary hover:underline font-semibold">Login Here</a></p>
            </form>
        </div>

        <!-- Authenticated Content - Hidden by default -->
        <div id="authenticatedContent" class="hidden">
            <!-- User ID & QR Code Display -->
            <div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded-lg mb-6 text-sm flex items-center justify-between flex-wrap">
                <span class="font-semibold mr-2">Your User ID:</span>
                <span id="userIdDisplay" class="font-mono text-xs md:text-sm break-all">Loading...</span>
                <button onclick="copyUserId()" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-1 px-3 rounded-md text-xs transition duration-300 ease-in-out ml-2 mt-2 md:mt-0">
                    <i class="fas fa-copy mr-1"></i> Copy ID
                </button>
                <button onclick="showQrCode()" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-1 px-3 rounded-md text-xs transition duration-300 ease-in-out ml-2 mt-2 md:mt-0">
                    <i class="fas fa-qrcode mr-1"></i> Show QR
                </button>
                <button onclick="logoutUser()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition duration-300 ease-in-out ml-2 mt-2 md:mt-0">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>

            <!-- Collapsible Sections for App-like Feel -->
            <div class="space-y-6">

                <!-- Add New Member / Self-Register Section -->
                <div class="bg-blue-50 rounded-xl border border-blue-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('selfRegistrationSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold">
                            <i class="fas fa-user-plus mr-2"></i> Add New Member / Self-Register
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="selfRegistrationSectionContent" class="collapsible-content">
                        <form id="addMemberForm" class="space-y-4 py-4">
                            <div>
                                <label for="profilePictureFile" class="block text-gray-700 font-semibold mb-2">Profile Picture (Optional):</label>
                                <input type="file" id="profilePictureFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                                <p class="text-xs text-gray-500 mt-1">Upload your profile photo. Large files may take longer to upload.</p>
                                <div id="profilePicturePreviewContainer" class="mt-2 hidden">
                                    <img id="profilePicturePreview" src="#" alt="Profile Picture Preview" class="max-w-xs h-auto rounded-lg border border-gray-300 rounded-full w-24 h-24 object-cover">
                                </div>
                                <div id="profilePictureUploadStatus" class="text-sm mt-1"></div>
                            </div>
                            <div>
                                <label for="fullName" class="block text-gray-700 font-semibold mb-2">Full Name:</label>
                                <input type="text" id="fullName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., Ahmed Ali" required>
                            </div>
                            <div>
                                <label for="fatherName" class="block text-gray-700 font-semibold mb-2">Father's Name:</label>
                                <input type="text" id="fatherName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., Muhammad Khan">
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-gray-700 font-semibold mb-2">Phone Number:</label>
                                <input type="text" id="phoneNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., 03001234567" required>
                            </div>
                            <div>
                                <label for="emergencyContactNumber" class="block text-gray-700 font-semibold mb-2">Emergency Contact Number (Optional):</label>
                                <input type="text" id="emergencyContactNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., 03331234567">
                            </div>
                            <div>
                                <label for="emergencyContactRelationship" class="block text-gray-700 font-semibold mb-2">Relationship to Emergency Contact (Optional):</label>
                                <input type="text" id="emergencyContactRelationship" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., Brother, Cousin, Friend">
                            </div>
                            <div>
                                <label for="address" class="block text-gray-700 font-semibold mb-2">Complete Home Address:</label>
                                <textarea id="address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., House No. 123, Street 5, Sector B, Mardan"></textarea>
                            </div>
                            <div>
                                <label for="bloodGroup" class="block text-gray-700 font-semibold mb-2">Blood Group:</label>
                                <select id="bloodGroup" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                                    <option value="">Select</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div>
                                <label for="pharmaceuticalCompanyName" class="block text-gray-700 font-semibold mb-2">Pharmaceutical Company Name (Optional):</label>
                                <input type="text" id="pharmaceuticalCompanyName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., XYZ Pharma">
                            </div>
                            <div>
                                <label for="designationInCompany" class="block text-gray-700 font-semibold mb-2">Designation in Company (Optional):</label>
                                <select id="designationInCompany" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                                    <option value="">Select</option>
                                    <option value="PS">PS</option>
                                    <option value="SPO">SPO</option>
                                    <option value="TM">TM</option>
                                    <option value="STM">STM</option>
                                    <option value="FE">FE</option>
                                    <option value="ASM">ASM</option>
                                    <option value="DSM">DSM</option>
                                    <option value="RSM">RSM</option>
                                    <option value="SM">SM</option>
                                    <option value="NSM">NSM</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="donationType" class="block text-gray-700 font-semibold mb-2">Donation Type (if applicable):</label>
                                <select id="donationType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                                    <option value="">Select</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Item">Item</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="donationDate" class="block text-gray-700 font-semibold mb-2">Date of Donation (if applicable):</label>
                                <input type="date" id="donationDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                            </div>
                            <div>
                                <label for="donationScreenshotFile" class="block text-gray-700 font-semibold mb-2">Donation Screenshot (Optional):</label>
                                <input type="file" id="donationScreenshotFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                                <p class="text-xs text-gray-500 mt-1">Upload a screenshot of your payment. Large files may take longer to upload.</p>
                                <div id="screenshotPreviewContainer" class="mt-2 hidden">
                                    <img id="screenshotPreview" src="#" alt="Screenshot Preview" class="max-w-xs h-auto rounded-lg border border-gray-300">
                                </div>
                                <div id="screenshotUploadStatus" class="text-sm mt-1"></div>
                            </div>
                            <div>
                                <label for="email" class="block text-gray-700 font-semibold mb-2">Email (Optional):</label>
                                <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200" placeholder="e.g., your@example.com">
                            </div>
                            <div>
                                <label for="gender" class="block text-gray-700 font-semibold mb-2">Gender (Optional):</label>
                                <select id="gender" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition duration-200">
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-primary hover:bg-primary-darker text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-plus-circle mr-2"></i> Register Member
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Admin Panel Section -->
                <div id="adminPanelSection" class="bg-gray-100 rounded-xl border border-gray-300 shadow-inner hidden">
                    <div class="collapsible-header" onclick="toggleSection('adminPanelSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">
                            <i class="fas fa-users-cog mr-2"></i> Admin Panel (All Members)
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="adminPanelSectionContent" class="collapsible-content">
                        <div class="flex flex-col md:flex-row gap-4 py-4">
                            <input type="text" id="adminSearchQuery" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent transition duration-200" placeholder="Search by Name, Phone, or CNIC...">
                            <select id="adminFilterStatus" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400">
                                <option value="All">All Statuses</option>
                                <option value="Pending">Pending Registration</option>
                                <option value="Verified">Verified Registration</option>
                                <option value="Rejected">Rejected Registration</option>
                            </select>
                            <select id="adminFilterBloodGroup" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400">
                                <option value="All">All Blood Groups</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                            <button onclick="applyAdminFilters()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 md:w-auto">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                        <div id="adminMembersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-center text-gray-500 col-span-full" id="noAdminMembersMessage">No registered members found for Admin Panel.</p>
                        </div>
                    </div>
                </div>

                <!-- Donation Accounts Section (Admin Only) -->
                <div id="donationAccountsSection" class="bg-green-50 rounded-xl border border-green-200 shadow-inner hidden">
                    <div class="collapsible-header" onclick="toggleSection('donationAccountsSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-green-700">
                            <i class="fas fa-hand-holding-usd mr-2"></i> Donation Accounts (Admin Control)
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="donationAccountsSectionContent" class="collapsible-content">
                        <form id="addDonationAccountForm" class="space-y-4 py-4">
                            <h3 class="text-lg font-bold text-green-700 mb-4">Add New Donation Account</h3>
                            <div>
                                <label for="accountType" class="block text-gray-700 font-semibold mb-2">Account Type:</label>
                                <select id="accountType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400" required>
                                    <option value="">Select</option>
                                    <option value="EasyPaisa">EasyPaisa</option>
                                    <option value="JazzCash">JazzCash</option>
                                    <option value="UCash">UCash</option>
                                    <option value="Bank Account">Bank Account</option>
                                </select>
                            </div>
                            <div id="mobileAccountFields" class="space-y-4">
                                <div>
                                    <label for="mobileAccountNumber" class="block text-gray-700 font-semibold mb-2">Mobile Account Number:</label>
                                    <input type="text" id="mobileAccountNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400" placeholder="e.g., 03001234567">
                                </div>
                                <div>
                                    <label for="mobileAccountTitle" class="block text-gray-700 font-semibold mb-2">Account Title:</label>
                                    <input type="text" id="mobileAccountTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400" placeholder="e.g., Kabir Khan">
                                </div>
                            </div>
                            <div id="bankAccountFields" class="space-y-4 hidden">
                                <div>
                                    <label for="bankName" class="block text-gray-700 font-semibold mb-2">Bank Name:</label>
                                    <input type="text" id="bankName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400" placeholder="e.g., HBL, Allied Bank">
                                </div>
                                <div>
                                    <label for="bankAccountNumber" class="block text-gray-700 font-semibold mb-2">Bank Account Number:</label>
                                    <input type="text" id="bankAccountNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400" placeholder="e.g., 0123456789012345">
                                </div>
                                <div>
                                    <label for="bankAccountTitle" class="block text-gray-700 font-semibold mb-2">Account Title:</label>
                                    <input type="text" id="bankAccountTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400" placeholder="e.g., Kabir Khan">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i> Add Account
                            </button>
                        </form>

                        <h3 class="text-lg font-bold text-green-700 mb-4">Current Donation Accounts:</h3>
                        <div id="currentDonationAccountsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-gray-500 col-span-full" id="noDonationAccountsMessage">No donation accounts added yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Message to User Section (Admin Only) -->
                <div id="adminMessageUserSection" class="bg-yellow-50 rounded-xl border border-yellow-200 shadow-inner hidden">
                    <div class="collapsible-header" onclick="toggleSection('adminMessageUserSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-yellow-700">
                            <i class="fas fa-envelope-open-text mr-2"></i> Send Message to User (Admin)
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="adminMessageUserSectionContent" class="collapsible-content">
                        <form id="adminMessageUserForm" class="space-y-4 py-4">
                            <div>
                                <label for="targetUserId" class="block text-gray-700 font-semibold mb-2">Target User ID (Optional - leave empty for all):</label>
                                <input type="text" id="targetUserId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400" placeholder="Enter User ID or leave empty for all users">
                                <p class="text-xs text-gray-500 mt-1">If left empty, the message will be sent to ALL registered users.</p>
                            </div>
                            <div>
                                <label for="adminMessageSubject" class="block text-gray-700 font-semibold mb-2">Subject:</label>
                                <input type="text" id="adminMessageSubject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400" placeholder="e.g., Important Update, Announcement" required>
                            </div>
                            <div>
                                <label for="adminMessageContent" class="block text-gray-700 font-semibold mb-2">Message Content:</label>
                                <textarea id="adminMessageContent" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400" placeholder="Type your message here..." required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-paper-plane mr-2"></i> Send Message
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Request Help Section -->
                <div class="bg-red-50 rounded-xl border border-red-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('requestHelpSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-red-700">
                            <i class="fas fa-hand-holding-heart mr-2"></i> Request Help
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="requestHelpSectionContent" class="collapsible-content">
                        <p class="text-gray-600 mb-4 text-center py-4">
                            If you are a registered member and need assistance, please fill out this form.
                        </p>
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <input type="text" id="helpIdentifyQuery" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent transition duration-200" placeholder="Your registered Phone Number or Full Name">
                            <button onclick="identifySelfForHelp()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105 md:w-auto">
                                <i class="fas fa-search mr-1"></i> Identify Me
                            </button>
                        </div>
                        <div id="helpIdentifyResult" class="text-center text-lg font-semibold text-gray-700 mt-4"></div>

                        <div id="helpRequestFormSection" class="mt-6 p-5 bg-white rounded-xl shadow-md border border-red-200 hidden">
                            <h3 class="text-lg font-bold text-red-700 mb-4">Submit Help Request for <span id="identifiedHelpMemberName" class="text-primary"></span></h3>
                            <div>
                                <label for="helpType" class="block text-gray-700 font-semibold mb-2">What do you need help with?</label>
                                <select id="helpType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent transition duration-200" required>
                                    <option value="">Select</option>
                                    <option value="Medical Assistance">Medical Assistance</option>
                                    <option value="Financial Assistance">Financial Assistance</option>
                                    <option value="Food Assistance">Food Assistance</option>
                                    <option value="Samples (Pharmaceutical)">Samples (Pharmaceutical)</option>
                                    <option value="Bike/Car Travel (Need a Ride)">Bike/Car Travel (Need a Ride)</option>
                                    <option value="Bike/Car Travel (Offer a Ride)">Bike/Car Travel (Offer a Ride)</option>
                                    <option value="Other Emergency">Other Emergency</option>
                                    <option value="General Inquiry">General Inquiry</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label for="issueExplanation" class="block text-gray-700 font-semibold mb-2">Explain your issue:</label>
                                <textarea id="issueExplanation" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" placeholder="Describe your situation in detail..." required></textarea>
                            </div>
                            <div class="mt-4">
                                <label for="documentLink" class="block text-gray-700 font-semibold mb-2">Supporting Document Link (Optional):</label>
                                <input type="url" id="documentLink" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-transparent transition duration-200" placeholder="Paste URL of document (e.g., medical report)">
                                <p class="text-xs text-gray-500 mt-1">Note: Direct file upload is not supported in this demo. Please upload your screenshot to a public image hosting service and paste the link here.</p>
                            </div>
                            <button onclick="submitHelpRequest()" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-paper-plane mr-2"></i> Submit Help Request
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Blood Request System -->
                <div class="bg-pink-50 rounded-xl border border-pink-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('bloodRequestSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-pink-700">
                            <i class="fas fa-tint mr-2"></i> Blood Request System
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="bloodRequestSectionContent" class="collapsible-content">
                        <form id="bloodRequestForm" class="space-y-4 py-4">
                            <div>
                                <label for="bloodRequestGroup" class="block text-gray-700 font-semibold mb-2">Required Blood Group:</label>
                                <select id="bloodRequestGroup" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition duration-200" required>
                                    <option value="">Select</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            <div>
                                <label for="bloodRequestCity" class="block text-gray-700 font-semibold mb-2">City:</label>
                                <input type="text" id="bloodRequestCity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition duration-200" placeholder="e.g., Mardan" required>
                            </div>
                            <div>
                                <label for="bloodRequestHospital" class="block text-gray-700 font-semibold mb-2">Hospital/Clinic (Optional):</label>
                                <input type="text" id="bloodRequestHospital" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition duration-200" placeholder="e.g., DHQ Hospital">
                            </div>
                            <div>
                                <label for="bloodRequestPatientName" class="block text-gray-700 font-semibold mb-2">Patient Name (Optional):</label>
                                <input type="text" id="bloodRequestPatientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition duration-200" placeholder="e.g., Ali Khan">
                            </div>
                            <div>
                                <label for="bloodRequestUnits" class="block text-gray-700 font-semibold mb-2">Units Required (Optional):</label>
                                <input type="number" id="bloodRequestUnits" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition duration-200" min="1" placeholder="e.g., 2">
                            </div>
                            <div>
                                <label for="urgencyLevel" class="block text-gray-700 font-semibold mb-2">Urgency Level:</label>
                                <select id="urgencyLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent transition duration-200" required>
                                    <option value="">Select</option>
                                    <option value="Immediate">Immediate (within hours)</option>
                                    <option value="Urgent">Urgent (within 24 hours)</option>
                                    <option value="Normal">Normal (within a few days)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-hand-point-up mr-2"></i> Request Blood
                            </button>
                        </form>
                        <div id="matchingDonorsList" class="mt-6">
                            <h3 class="text-lg font-bold text-pink-700 mb-4">Matching Donors:</h3>
                            <div id="donorsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p class="text-gray-500 col-span-full" id="noMatchingDonorsMessage">No matching donors found yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Samples Request System -->
                <div class="bg-purple-50 rounded-xl border border-purple-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('samplesRequestSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-purple-700">
                            <i class="fas fa-pills mr-2"></i> Samples Request System
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="samplesRequestSectionContent" class="collapsible-content">
                        <form id="addSampleRequestForm" class="space-y-4 py-4">
                            <div>
                                <label for="sampleProductName" class="block text-gray-700 font-semibold mb-2">Product Name:</label>
                                <input type="text" id="sampleProductName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" placeholder="e.g., Panadol, Amoxicillin" required>
                            </div>
                            <div>
                                <label for="sampleNumberOfDoses" class="block text-gray-700 font-semibold mb-2">Number of Doses/Units:</label>
                                <input type="number" id="sampleNumberOfDoses" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" min="1" placeholder="e.g., 10 tablets, 2 vials" required>
                            </div>
                            <div>
                                <label for="sampleStrength" class="block text-gray-700 font-semibold mb-2">Strength (Optional):</label>
                                <input type="text" id="sampleStrength" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" placeholder="e.g., 500mg, 250mg/5ml">
                            </div>
                            <div>
                                <label for="sampleForm" class="block text-gray-700 font-semibold mb-2">Form (Optional):</label>
                                <input type="text" id="sampleForm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" placeholder="e.g., Tablet, Syrup, Injection">
                            </div>
                            <div>
                                <label for="sampleAdditionalDetails" class="block text-gray-700 font-semibold mb-2">Additional Details (Optional):</label>
                                <textarea id="sampleAdditionalDetails" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" placeholder="Any specific requirements or urgency..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-plus-square mr-2"></i> Request Samples
                            </button>
                        </form>
                        <div id="sampleRequestsList" class="mt-6">
                            <h3 class="text-lg font-bold text-purple-700 mb-4">Active Sample Requests:</h3>
                            <div id="samplesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p class="text-gray-500 col-span-full" id="noSamplesMessage">No active sample requests.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Doctor Visit Information (Public Posting) -->
                <div class="bg-blue-100 rounded-xl border border-blue-300 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('doctorVisitInfoSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-blue-800">
                            <i class="fas fa-user-md mr-2"></i> Doctor Visit Information
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="doctorVisitInfoSectionContent" class="collapsible-content">
                        <form id="addDoctorVisitForm" class="space-y-4 py-4">
                            <h3 class="text-lg font-bold text-blue-800 mb-4">Post Doctor's Visit Details</h3>
                            <div>
                                <label for="doctorVisitName" class="block text-gray-700 font-semibold mb-2">Doctor's Name:</label>
                                <input type="text" id="doctorVisitName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="e.g., Dr. Asif" required>
                            </div>
                            <div>
                                <label for="doctorContactNumber" class="block text-gray-700 font-semibold mb-2">Doctor's Contact Number (Optional):</label>
                                <input type="text" id="doctorContactNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="e.g., 03001234567">
                            </div>
                            <div>
                                <label for="doctorAttendanceNumber" class="block text-gray-700 font-semibold mb-2">Doctor's Attendance Number (Optional):</label>
                                <input type="text" id="doctorAttendanceNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="e.g., 03007654321">
                            </div>
                            <div>
                                <label for="doctorVisitTime" class="block text-gray-700 font-semibold mb-2">Visiting Time:</label>
                                <input type="text" id="doctorVisitTime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="e.g., 10:00 AM - 1:00 PM" required>
                            </div>
                            <div>
                                <label for="doctorVisitDate" class="block text-gray-700 font-semibold mb-2">Date of Visit:</label>
                                <input type="date" id="doctorVisitDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" required>
                            </div>
                            <div>
                                <label for="doctorVisitLocation" class="block text-gray-700 font-semibold mb-2">Location (Optional):</label>
                                <input type="text" id="doctorVisitLocation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="e.g., ABC Hospital, Mardan">
                            </div>
                            <div>
                                <label for="doctorVisitNotes" class="block text-gray-700 font-semibold mb-2">Notes (Optional):</label>
                                <textarea id="doctorVisitNotes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" placeholder="e.g., Only for checkups, Limited patients"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-calendar-alt mr-2"></i> Post Doctor Visit
                            </button>
                        </form>

                        <h3 class="text-lg font-bold text-blue-800 mb-4">Active Doctor Visit Posts:</h3>
                        <div id="doctorVisitPostsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-gray-500 col-span-full" id="noDoctorVisitPostsMessage">No doctor visit posts available yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Daily Travel Posts (Carpooling/Ride-Sharing) -->
                <div class="bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('dailyTravelSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-indigo-700">
                            <i class="fas fa-car-side mr-2"></i> Daily Travel Posts (Carpooling/Ride-Sharing)
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="dailyTravelSectionContent" class="collapsible-content">
                        <form id="addTravelPostForm" class="space-y-4 py-4">
                            <h3 class="text-lg font-bold text-indigo-700 mb-4">Offer or Request a Ride</h3>
                            <div>
                                <label for="travelType" class="block text-gray-700 font-semibold mb-2">Travel Type:</label>
                                <select id="travelType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" required>
                                    <option value="">Select</option>
                                    <option value="Offer Ride">Offer a Ride (I have a car/bike)</option>
                                    <option value="Need Ride">Need a Ride (I need a lift)</option>
                                </select>
                            </div>
                            <div>
                                <label for="travelOrigin" class="block text-gray-700 font-semibold mb-2">Origin City/Area:</label>
                                <input type="text" id="travelOrigin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="e.g., Mardan City" required>
                            </div>
                            <div>
                                <label for="travelDestination" class="block text-gray-700 font-semibold mb-2">Destination City/Area:</label>
                                <input type="text" id="travelDestination" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="e.g., Swabi" required>
                            </div>
                            <div>
                                <label for="travelDate" class="block text-gray-700 font-semibold mb-2">Date of Travel:</label>
                                <input type="date" id="travelDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <div>
                                <label for="travelTime" class="block text-gray-700 font-semibold mb-2">Approx. Time of Travel:</label>
                                <input type="time" id="travelTime" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <div id="availableSeatsField" class="hidden">
                                <label for="availableSeats" class="block text-gray-700 font-semibold mb-2">Available Seats:</label>
                                <input type="number" id="availableSeats" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" min="1" placeholder="e.g., 2">
                            </div>
                            <div>
                                <label for="travelPurpose" class="block text-gray-700 font-semibold mb-2">Purpose of Travel (Optional):</label>
                                <input type="text" id="travelPurpose" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="e.g., Office, Hospital, Family Visit">
                            </div>
                            <div>
                                <label for="travelNotes" class="block text-gray-700 font-semibold mb-2">Additional Notes (Optional):</label>
                                <textarea id="travelNotes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="e.g., Luggage space available, prefer female passengers"></textarea>
                            </div>
                            <div>
                                <label for="travelContactNumber" class="block text-gray-700 font-semibold mb-2">Your Contact Number:</label>
                                <input type="text" id="travelContactNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="e.g., 03001234567" required>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-route mr-2"></i> Post Travel
                            </button>
                        </form>

                        <h3 class="text-lg font-bold text-indigo-700 mb-4">Active Travel Posts:</h3>
                        <div id="travelPostsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-gray-500 col-span-full" id="noTravelPostsMessage">No active travel posts.</p>
                        </div>
                    </div>
                </div>

                <!-- Volunteer Sign-Up System -->
                <div class="bg-yellow-50 rounded-xl border border-yellow-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('volunteerSignUpSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-yellow-700">
                            <i class="fas fa-hands-helping mr-2"></i> Volunteer Sign-Up
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="volunteerSignUpSectionContent" class="collapsible-content">
                        <form id="volunteerSignUpForm" class="space-y-4 py-4">
                            <div>
                                <label for="volunteerName" class="block text-gray-700 font-semibold mb-2">Full Name:</label>
                                <input type="text" id="volunteerName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition duration-200" placeholder="e.g., Ali Raza" required>
                            </div>
                            <div>
                                <label for="volunteerPhone" class="block text-gray-700 font-semibold mb-2">Phone Number:</label>
                                <input type="text" id="volunteerPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition duration-200" placeholder="e.g., 03001234567" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Skills/Roles:</label>
                                <div class="flex flex-wrap gap-3">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="volunteerSkill" value="Driver" class="form-checkbox h-5 w-5 text-yellow-600 rounded">
                                        <span class="ml-2 text-gray-700">Driver (blood pick/drop)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="volunteerSkill" value="Supporter" class="form-checkbox h-5 w-5 text-yellow-600 rounded">
                                        <span class="ml-2 text-gray-700">Supporter (visit patient)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="volunteerSkill" value="Medical Help" class="form-checkbox h-5 w-5 text-yellow-600 rounded">
                                        <span class="ml-2 text-gray-700">Medical Help (nurse/doctor)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="volunteerSkill" value="Other" class="form-checkbox h-5 w-5 text-yellow-600 rounded">
                                        <span class="ml-2 text-gray-700">Other</span>
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-user-check mr-2"></i> Sign Up as Volunteer
                            </button>
                        </form>
                        <div id="volunteersList" class="mt-6">
                            <h3 class="text-lg font-bold text-yellow-700 mb-4">Registered Volunteers:</h3>
                            <div id="volunteersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p class="text-gray-500 col-span-full" id="noVolunteersMessage">No volunteers registered yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Free Health Camps & Events Section -->
                <div class="bg-teal-50 rounded-xl border border-teal-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('eventsSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-teal-700">
                            <i class="fas fa-calendar-check mr-2"></i> Health Camps & Events
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="eventsSectionContent" class="collapsible-content">
                        <div id="addEventFormContainer" class="hidden py-4"> <!-- Admin only -->
                            <form id="addEventForm" class="space-y-4 mb-6">
                                <h3 class="text-lg font-bold text-teal-700 mb-4">Add New Event (Admin/Team)</h3>
                                <div>
                                    <label for="eventName" class="block text-gray-700 font-semibold mb-2">Event Name:</label>
                                    <input type="text" id="eventName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="e.g., Free Eye Camp" required>
                                </div>
                                <div>
                                    <label for="eventDescription" class="block text-gray-700 font-semibold mb-2">Description:</label>
                                    <textarea id="eventDescription" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="Details about the event..." required></textarea>
                                </div>
                                <div>
                                    <label for="eventDate" class="block text-gray-700 font-semibold mb-2">Date:</label>
                                    <input type="date" id="eventDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400" required>
                                </div>
                                <div>
                                    <label for="eventLocation" class="block text-gray-700 font-semibold mb-2">Location:</label>
                                    <input type="text" id="eventLocation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="e.g., SMR Mardan Office" required>
                                </div>
                                <div>
                                    <label for="eventMapLink" class="block text-gray-700 font-semibold mb-2">Map Link (Optional):</label>
                                    <input type="url" id="eventMapLink" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="e.g., https://goo.gl/maps/...">
                                </div>
                                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                    <i class="fas fa-plus mr-2"></i> Add Event
                                </button>
                            </form>
                        </div>

                        <h3 class="text-lg font-bold text-teal-700 mb-4">Upcoming Events:</h3>
                        <div id="eventsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <p class="text-gray-500 col-span-full" id="noEventsMessage">No upcoming events scheduled.</p>
                        </div>
                    </div>
                </div>

                <!-- Live Community Feed / Wall -->
                <div class="bg-orange-50 rounded-xl border border-orange-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('communityFeedSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-orange-700">
                            <i class="fas fa-bullhorn mr-2"></i> Community Feed / Success Stories
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="communityFeedSectionContent" class="collapsible-content">
                        <div id="addPostFormContainer" class="hidden py-4"> <!-- Admin only -->
                            <form id="addPostForm" class="space-y-4 mb-6">
                                <div>
                                    <label for="postContent" class="block text-gray-700 font-semibold mb-2">Share a Post / Success Story:</label>
                                    <textarea id="postContent" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400" placeholder="What's new in the community? Share a success story!" required></textarea>
                                </div>
                                <div>
                                    <label for="postImageLink" class="block text-gray-700 font-semibold mb-2">Image Link (Optional):</label>
                                    <input type="url" id="postImageLink" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400" placeholder="Paste URL of image">
                                </div>
                                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                    <i class="fas fa-paper-plane mr-2"></i> Post to Feed
                                </button>
                            </form>
                        </div>

                        <div id="communityFeedList" class="space-y-6">
                            <p class="text-center text-gray-500" id="noPostsMessage">No posts in the community feed yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Chat / Message Admin Option -->
                <div class="bg-purple-50 rounded-xl border border-purple-200 shadow-inner">
                    <div class="collapsible-header" onclick="toggleSection('messageAdminSectionContent')">
                        <h2 class="text-xl md:text-2xl font-bold text-purple-700">
                            <i class="fas fa-comment-dots mr-2"></i> Message Admin
                        </h2>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    </div>
                    <div id="messageAdminSectionContent" class="collapsible-content">
                        <form id="messageAdminForm" class="space-y-4 py-4">
                            <div>
                                <label for="messageSubject" class="block text-gray-700 font-semibold mb-2">Subject:</label>
                                <input type="text" id="messageSubject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" placeholder="e.g., Suggestion, Complaint, Status Inquiry" required>
                            </div>
                            <div>
                                <label for="messageContent" class="block text-gray-700 font-semibold mb-2">Your Message:</label>
                                <textarea id="messageContent" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" placeholder="Type your message here..." required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                                <i class="fas fa-envelope mr-2"></i> Send Message
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Emergency Alert Button -->
                <div class="bg-red-100 rounded-xl border border-red-300 shadow-lg text-center p-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-red-800 mb-6">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Emergency Alert (SOS)
                    </h2>
                    <p class="text-gray-700 mb-6">
                        Click this button in case of immediate emergency (Medical, Accident, Crisis).
                        Your location will be shared with the SMR MARDAN team.
                    </p>
                    <button onclick="sendEmergencyAlert()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-4 px-8 rounded-full shadow-xl hover:shadow-2xl transition duration-300 ease-in-out transform hover:scale-105 animate-pulse">
                         Help Me Now! 
                    </button>
                    <p id="emergencyStatus" class="mt-4 text-sm text-gray-600"></p>
                </div>

            </div> <!-- End of Collapsible Sections -->
        </div> <!-- End of Authenticated Content -->

    </div>

    <!-- Custom Message Modal -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-primary">
            <h3 id="messageTitle" class="text-xl font-bold text-primary mb-4"></h3>
            <p id="messageContent" class="text-gray-700 mb-6"></p>
            <button onclick="hideMessage()" class="w-full bg-primary hover:bg-primary-darker text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                OK
            </button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xs text-center border border-primary">
            <h3 class="text-xl font-bold text-primary mb-4">Your SMR MARDAN ID QR Code</h3>
            <canvas id="qrCanvas" class="w-full h-auto max-w-full block mx-auto border border-gray-300 rounded-lg"></canvas>
            <p class="text-sm text-gray-600 mt-2">Scan this to quickly access your profile.</p>
            <button onclick="hideQrCode()" class="mt-6 w-full bg-primary hover:bg-primary-darker text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                Close
            </button>
        </div>
    </div>

    <!-- Member Details Modal (for Admin Panel) -->
    <div id="memberDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl border border-primary overflow-y-auto max-h-[90vh]">
            <h3 class="text-2xl font-bold text-primary mb-4" id="modalMemberName"></h3>
            <div class="space-y-3 text-gray-700 mb-6">
                <div class="flex items-center space-x-4 mb-4">
                    <img id="modalProfilePicture" src="https://placehold.co/100x100/aabbcc/ffffff?text=No+Photo" alt="Profile Picture" class="w-24 h-24 object-cover rounded-full border-2 border-primary">
                    <div>
                        <p><span class="font-semibold">Full Name:</span> <span id="modalMemberFullName"></span></p>
                        <p><span class="font-semibold">Father's Name:</span> <span id="modalMemberFatherName"></span></p>
                        <p><span class="font-semibold">Phone:</span> <span id="modalMemberPhone"></span> <a id="modalMemberCall" href="#" class="text-blue-500 hover:underline ml-2"> Call</a> <a id="modalMemberWhatsApp" href="#" target="_blank" class="text-green-500 hover:underline ml-2"> WhatsApp</a></p>
                        <p><span class="font-semibold">Emergency Contact:</span> <span id="modalMemberEmergencyContact"></span></p>
                        <p><span class="font-semibold">Address:</span> <span id="modalMemberAddress"></span></p>
                        <p><span class="font-semibold">Blood Group:</span> <span id="modalMemberBloodGroup"></span></p>
                        <p><span class="font-semibold">Company:</span> <span id="modalMemberCompanyName"></span></p>
                        <p><span class="font-semibold">Designation:</span> <span id="modalMemberDesignation"></span></p>
                        <p><span class="font-semibold">Email:</span> <span id="modalMemberEmail"></span></p>
                        <p><span class="font-semibold">Gender:</span> <span id="modalMemberGender"></span></p>
                        <p><span class="font-semibold">Registered By:</span> <span id="modalMemberAddedBy"></span></p>
                        <p><span class="font-semibold">Registration Date:</span> <span id="modalMemberRegDate"></span></p>
                        <p><span class="font-semibold">Current Status:</span> <span id="modalMemberStatus" class="font-bold"></span></p>
                        <p><span class="font-semibold">Donor Badge:</span> <span id="modalDonorBadge" class="font-bold text-purple-700"></span></p>
                    </div>
                </div>
            </div>

            <h4 class="text-xl font-bold text-primary mb-3">Donation Proofs: <span id="totalVerifiedDonations" class="text-green-main text-lg ml-2"></span></h4>
            <div id="modalDonationProofsList" class="space-y-3 mb-6">
                <p class="text-gray-500 text-sm" id="noModalDonationProofs">No donation proofs submitted yet.</p>
            </div>
            <!-- Gemini AI for Donation Impact Summary -->
            <button id="summarizeDonationsBtn" onclick="summarizeDonationImpact()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md mb-4 transition duration-300 ease-in-out text-sm">
                <i class="fas fa-magic mr-1"></i> Summarize Donation Impact 
            </button>
            <div id="donationImpactSummary" class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-gray-700 text-sm hidden">
                <p class="font-semibold mb-1">AI-Generated Summary:</p>
                <p id="donationSummaryContent">Loading...</p>
                <div id="donationSummaryLoading" class="text-center text-blue-500 hidden">Loading...</div>
            </div>


            <h4 class="text-xl font-bold text-primary mb-3">Blood Request History: <span id="totalFulfilledBloodRequests" class="text-green-main text-lg ml-2"></span></h4>
            <div id="modalBloodRequestsList" class="space-y-3 mb-6">
                <p class="text-gray-500 text-sm" id="noModalBloodRequests">No blood requests made by this member.</p>
            </div>

            <h4 class="text-xl font-bold text-primary mb-3">Assistance Requests:</h4>
            <div id="modalAssistanceRequestsList" class="space-y-3 mb-6">
                <p class="text-gray-500 text-sm" id="noModalAssistanceRequests">No assistance requests submitted yet.</p>
            </div>
            <!-- Gemini AI for Help Request Clarification (added dynamically per request) -->


            <h4 class="text-xl font-bold text-primary mb-3">Admin Notes:</h4>
            <textarea id="modalAdminNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Add notes about this member..."></textarea>
            <button onclick="saveAdminNotes()" class="mt-2 bg-primary hover:bg-primary-darker text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                <i class="fas fa-save mr-1"></i> Save Notes
            </button>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="updateMemberStatus('Verified')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    <i class="fas fa-check-circle mr-1"></i> Verify Member
                </button>
                <button onclick="updateMemberStatus('Rejected')" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    <i class="fas fa-times-circle mr-1"></i> Reject Member
                </button>
                <button onclick="deleteMemberFromModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    <i class="fas fa-trash-alt mr-1"></i> Delete Member
                </button>
                <button onclick="hideMemberDetailsModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    <i class="fas fa-times mr-1"></i> Close
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global Firebase variables
        let firebaseApp;
        let db;
        let auth;
        let storage;
        let userId = null;
        let isAuthenticated = false; // New flag for general authentication status
        let isAdminUser = false; // New flag to track admin status
        let currentAdminViewMemberId = null; // Stores the ID of the member currently viewed in admin modal
        let identifiedHelpMemberId = null; // Stores the ID of the member who identified themselves for help request
        let deferredPrompt; // To store the beforeinstallprompt event

        // IMPORTANT: Replace these with the actual User IDs of your 4 admin users.
        // You can find your User ID displayed at the top of the app after it loads.
        const ADMIN_USER_IDS = [
            "dummy_admin_id_alpha_123", // Yeh aapki pehli misaali (example) admin ID hai
            "dummy_admin_id_beta_456"  // Yeh aapki doosri misaali (example) admin ID hai
        ];

        // Retrieve app-specific configurations from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-smr-mardan-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Configuration (Aapke diye gaye keys yahan hain)
        const firebaseConfig = {
            apiKey: "AIzaSyDA2ikGehQbrL0B3EuiRHgn2YGrTawSVhg",
            authDomain: "smr-community-61b47.firebaseapp.com",
            projectId: "smr-community-61b47",
            storageBucket: "smr-community-61b47.firebasestorage.app",
            messagingSenderId: "121903719731",
            appId: "1:121903719731:web:c290939b2089e841fc8a46"
        };


        // --- PWA Install Prompt Logic ---
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            const installBanner = document.getElementById('installBanner');
            if (installBanner) { // Null check added
                installBanner.classList.remove('hidden');
            }
            console.log('beforeinstallprompt event fired.');
        });

        document.getElementById('installButton').addEventListener('click', async () => {
            const installBanner = document.getElementById('installBanner');
            if (installBanner) { // Null check added
                installBanner.classList.add('hidden'); // Hide the banner
            }

            if (deferredPrompt) {
                deferredPrompt.prompt(); // Show the install prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // We've used the prompt, and can't use it again until a new beforeinstallprompt event is fired.
                deferredPrompt = null;
            } else {
                // Fallback for iOS or if prompt was already dismissed
                showMessage('Install App', 'To install the app, use your browser\'s "Add to Home Screen" option. For iOS, use the Share button <i class="fas fa-share-square"></i> and then "Add to Home Screen". For Android, look for "Install app" in the browser menu.');
            }
        });

        window.hideInstallBanner = function() {
            const installBanner = document.getElementById('installBanner');
            if (installBanner) { // Null check added
                installBanner.classList.add('hidden');
            }
        };


        // --- Utility Functions ---

        /**
         * Toggles the visibility of a collapsible section.
         * @param {string} contentId - The ID of the content div to toggle.
         */
        window.toggleSection = function(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling; // The header is the sibling before content

            if (content && header) { // Null check added
                if (content.classList.contains('active')) {
                    content.classList.remove('active');
                    header.classList.remove('active');
                } else {
                    // Close all other open sections
                    document.querySelectorAll('.collapsible-content.active').forEach(openContent => {
                        if (openContent && openContent.previousElementSibling) { // Null check added
                            openContent.classList.remove('active');
                            openContent.previousElementSibling.classList.remove('active');
                        }
                    });
                    // Open the clicked section
                    content.classList.add('active');
                    header.classList.add('active');
                }
            }
        };

        /**
         * Displays a custom message modal.
         * @param {string} title - The title of the message.
         * @param {string} message - The content of the message.
         */
        function showMessage(title, message) {
            const messageTitle = document.getElementById('messageTitle');
            const messageContent = document.getElementById('messageContent');
            const messageModal = document.getElementById('messageModal');

            if (messageTitle) messageTitle.innerText = title; // Null check added
            if (messageContent) messageContent.innerHTML = message; // Null check added
            if (messageModal) messageModal.classList.remove('hidden'); // Null check added
        }

        /**
         * Hides the custom message modal.
         */
        window.hideMessage = function() {
            const messageModal = document.getElementById('messageModal');
            if (messageModal) { // Null check added
                messageModal.classList.add('hidden');
            }
        }

        /**
         * Copies the user ID to the clipboard.
         */
        window.copyUserId = function() {
            const userIdTextElement = document.getElementById('userIdDisplay');
            if (!userIdTextElement) { // Null check added
                showMessage('Error', 'User ID display element not found.');
                return;
            }
            const userIdText = userIdTextElement.innerText;
            if (userIdText && userIdText !== 'Loading...') {
                const textarea = document.createElement('textarea');
                textarea.value = userIdText;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Copied!', 'User ID copied to clipboard.');
                } catch (err) {
                    showMessage('Failed to Copy', 'Failed to copy User ID. Please copy manually.');
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textarea);
            } else {
                showMessage('No User ID', 'User ID is not available yet.');
            }
        };

        /**
         * Shows the QR code modal for the current user ID.
         */
        window.showQrCode = function() {
            const userIdTextElement = document.getElementById('userIdDisplay');
            const qrCanvas = document.getElementById('qrCanvas');
            const qrCodeModal = document.getElementById('qrCodeModal');

            if (!userIdTextElement || !qrCanvas || !qrCodeModal) { // Null check added
                showMessage('Error', 'Required QR code elements not found.');
                return;
            }

            const userIdText = userIdTextElement.innerText;
            if (userIdText && userIdText !== 'Loading...') {
                new QRious({
                    element: qrCanvas,
                    value: userIdText,
                    size: 200,
                    level: 'H'
                });
                qrCodeModal.classList.remove('hidden');
            } else {
                showMessage('No User ID', 'User ID is not available yet to generate QR code.');
            }
        };

        /**
         * Hides the QR code modal.
         */
        window.hideQrCode = function() {
            const qrCodeModal = document.getElementById('qrCodeModal');
            if (qrCodeModal) { // Null check added
                qrCodeModal.classList.add('hidden');
            }
        };

        /**
         * Calculates donor badge based on donation proofs.
         * @param {number} donationCount - Number of verified donations.
         * @returns {string} Badge name.
         */
        function getDonorBadge(donationCount) {
            if (donationCount >= 10) return ' Hero of Community';
            if (donationCount >= 5) return ' Gold Donor';
            if (donationCount >= 3) return ' Silver Donor';
            if (donationCount >= 1) return ' Bronze Donor';
            return 'No Donor Badge';
        }

        /**
         * Renders a member card for the Admin Panel list.
         * @param {Object} member - The member data.
         * @param {string} member.id - The document ID of the member.
         * @returns {string} HTML string for the member card.
         */
        function renderAdminMemberCard(member) {
            const statusColor = {
                'Pending': 'text-yellow-600',
                'Verified': 'text-green-600',
                'Rejected': 'text-red-600'
            }[member.status] || 'text-gray-600';

            return `
                <div class="bg-white p-5 rounded-lg shadow-md border border-gray-200 flex flex-col justify-between cursor-pointer hover:shadow-lg transition duration-200 app-card" onclick="showMemberDetails('${member.id}')">
                    <div>
                        <h3 class="text-xl font-bold text-primary mb-2">${member.fullName}</h3>
                        <p class="text-gray-700 mb-1"><span class="font-semibold">Phone:</span> ${member.phoneNumber}</p>
                        <p class="text-gray-600 text-sm mb-1"><span class="font-semibold">Blood Group:</span> ${member.bloodGroup || 'N/A'}</p>
                        <p class="text-sm font-semibold ${statusColor}">Status: ${member.status || 'Pending'}</p>
                        <p class="text-gray-500 text-xs mt-3">Added By: <span class="font-mono break-all">${member.addedByUserId}</span></p>
                    </div>
                </div>
            `;
        }

        /**
         * Renders a donation proof card.
         * @param {Object} proof - The donation proof data.
         * @returns {string} HTML string for the donation proof card.
         */
        function renderDonationProofCard(proof) {
            const statusColor = {
                'Pending': 'text-yellow-600',
                'Verified': 'text-green-600',
                'Rejected': 'text-red-600'
            }[proof.status] || 'text-gray-600';

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-gray-700 mb-1">${proof.description}</p>
                    ${proof.screenshotLink ? `<a href="${proof.screenshotLink}" target="_blank" class="text-blue-500 hover:underline text-sm block mt-1">View Screenshot <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>` : ''}
                    <p class="text-gray-500 text-xs">Submitted: ${new Date(proof.submittedAt).toLocaleDateString()} by <span class="font-mono break-all">${proof.submittedByUserId}</span></p>
                    <p class="text-sm font-semibold ${statusColor}">Status: ${proof.status}</p>
                    ${isAdminUser ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="updateDonationProofStatus('${proof.memberId}', '${proof.id}', 'Verified')" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-check mr-1"></i> Verify</button>
                            <button onclick="updateDonationProofStatus('${proof.memberId}', '${proof.id}', 'Rejected')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-times mr-1"></i> Reject</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Renders an assistance request card.
         * @param {Object} request - The assistance request data.
         * @returns {string} HTML string for the request card.
         */
        function renderAssistanceRequestCard(request) {
            const statusColor = {
                'Under Review': 'text-yellow-600',
                'Approved': 'text-green-600',
                'Rejected': 'text-red-600',
                'Fulfilled': 'text-green-700'
            }[request.status] || 'text-gray-600';

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-gray-700 mb-1"><span class="font-semibold">Type:</span> ${request.type}</p>
                    <p class="text-gray-700 mb-1">${request.issueDescription}</p>
                    ${request.documentLink ? `<a href="${request.documentLink}" target="_blank" class="text-blue-500 hover:underline text-sm block mt-1">View Document <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>` : ''}
                    <p class="text-gray-500 text-xs">Requested: ${new Date(request.requestDate).toLocaleDateString()} by <span class="font-mono break-all">${request.requestedByUserId}</span></p>
                    <p class="text-sm font-semibold ${statusColor}">Status: ${request.status}</p>
                    ${isAdminUser ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="updateAssistanceRequestStatus('${request.memberId}', '${request.id}', 'Approved')" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-check mr-1"></i> Approve</button>
                            <button onclick="updateAssistanceRequestStatus('${request.memberId}', '${request.id}', 'Rejected')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-times mr-1"></i> Reject</button>
                            <button onclick="updateAssistanceRequestStatus('${request.memberId}', '${request.id}', 'Fulfilled')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-clipboard-check mr-1"></i> Fulfilled</button>
                        </div>
                        <button onclick="clarifyAssistanceRequest('${request.memberId}', '${request.id}', \`${request.issueDescription.replace(/`/g, '\\`')}\`)" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white text-xs px-2 py-1 rounded">
                            <i class="fas fa-lightbulb mr-1"></i> Clarify Request 
                        </button>
                        <div id="clarifyRequestSummary_${request.id}" class="bg-purple-100 p-2 rounded-lg border border-purple-200 text-gray-700 text-xs mt-2 hidden">
                            <p class="font-semibold mb-1">AI Insights:</p>
                            <p id="clarifyRequestContent_${request.id}">Loading...</p>
                            <div id="clarifyRequestLoading_${request.id}" class="text-center text-purple-500 hidden">Loading...</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Renders a blood request card for the member's history.
         * @param {Object} bloodRequest - The blood request data.
         * @returns {string} HTML string for the blood request card.
         */
        function renderBloodRequestHistoryCard(bloodRequest) {
            const statusColor = {
                'Active': 'text-yellow-600',
                'Fulfilled': 'text-green-600',
                'Cancelled': 'text-red-600'
            }[bloodRequest.status] || 'text-gray-600';

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-gray-700 mb-1"><span class="font-semibold">Blood Group:</span> ${bloodRequest.bloodGroup}</p>
                    <p class="text-gray-700 mb-1"><span class="font-semibold">City:</span> ${bloodRequest.city}</p>
                    ${bloodRequest.hospital ? `<p class="text-gray-700 mb-1"><span class="font-semibold">Hospital:</span> ${bloodRequest.hospital}</p>` : ''}
                    ${bloodRequest.patientName ? `<p class="text-gray-700 mb-1"><span class="font-semibold">Patient:</span> ${bloodRequest.patientName}</p>` : ''}
                    ${bloodRequest.units ? `<p class="text-gray-700 mb-1"><span class="font-semibold">Units:</span> ${bloodRequest.units}</p>` : ''}
                    <p class="text-gray-700 mb-1"><span class="font-semibold">Urgency:</span> ${bloodRequest.urgency}</p>
                    <p class="text-gray-500 text-xs">Requested: ${new Date(bloodRequest.requestDate).toLocaleDateString()} by <span class="font-mono break-all">${bloodRequest.requestedByUserId}</span></p>
                    <p class="text-sm font-semibold ${statusColor}">Status: ${bloodRequest.status}</p>
                    ${isAdminUser ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="updateBloodRequestStatus('${bloodRequest.id}', 'Fulfilled')" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-check mr-1"></i> Fulfilled</button>
                            <button onclick="updateBloodRequestStatus('${bloodRequest.id}', 'Cancelled')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-times mr-1"></i> Cancel</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Renders a matching donor card for the blood request system.
         * @param {Object} donor - The donor member data.
         * @returns {string} HTML string for the donor card.
         */
        function renderMatchingDonorCard(donor) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-pink-200 app-card">
                    <h4 class="font-bold text-pink-800">${donor.fullName}</h4>
                    <p class="text-gray-700 text-sm">Phone: ${donor.phoneNumber}</p>
                    <p class="text-gray-700 text-sm">Blood Group: ${donor.bloodGroup}</p>
                    <div class="mt-2 flex gap-2">
                        <a href="tel:${donor.phoneNumber}" class="text-blue-500 hover:underline text-xs"><i class="fas fa-phone-alt mr-1"></i> Call</a>
                        <a href="https://wa.me/${donor.phoneNumber}" target="_blank" class="text-green-500 hover:underline text-xs"><i class="fab fa-whatsapp mr-1"></i> WhatsApp</a>
                    </div>
                </div>
            `;
        }

        /**
         * Renders a donation account card for display to users.
         * @param {Object} account - The donation account data.
         * @param {boolean} forAdmin - True if rendering for admin panel.
         * @returns {string} HTML string for the account card.
         */
        function renderDonationAccountCard(account, forAdmin = false) {
            let details = '';
            if (account.accountType === 'Bank Account') {
                details = `
                    <p class="text-gray-700 text-sm"><span class="font-semibold">Bank:</span> ${account.bankName}</p>
                    <p class="text-gray-700 text-sm"><span class="font-semibold">Account No:</span> ${account.bankAccountNumber}</p>
                `;
            } else {
                details = `
                    <p class="text-gray-700 text-sm"><span class="font-semibold">Number:</span> ${account.mobileAccountNumber}</p>
                `;
            }

            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-green-200 app-card">
                    <h4 class="font-bold text-green-800">${account.accountType}</h4>
                    <p class="text-gray-700 text-sm"><span class="font-semibold">Account Title:</span> ${account.accountTitle}</p>
                    ${details}
                    ${forAdmin ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="editDonationAccount('${account.id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-edit mr-1"></i> Edit</button>
                            <button onclick="deleteDonationAccount('${account.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-trash-alt mr-1"></i> Delete</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Renders a sample request card.
         * @param {Object} request - The sample request data.
         * @returns {string} HTML string for the sample request card.
         */
        function renderSampleRequestCard(request) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200 app-card">
                    <h4 class="font-bold text-purple-800">${request.productName} - ${request.numberOfDoses} doses</h4>
                    ${request.strength ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Strength:</span> ${request.strength}</p>` : ''}
                    ${request.form ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Form:</span> ${request.form}</p>` : ''}
                    <p class="text-gray-700 text-sm">${request.additionalDetails || 'No additional details.'}</p>
                    <p class="text-gray-500 text-xs mt-2">Requested by: <span class="font-mono break-all">${request.requestedByUserId}</span> on ${new Date(request.requestDate).toLocaleDateString()}</p>
                    ${isAdminUser ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="markSampleRequestFulfilled('${request.id}')" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-check mr-1"></i> Mark Fulfilled</button>
                            <button onclick="deleteSampleRequest('${request.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-trash-alt mr-1"></i> Delete</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Renders a doctor visit post card.
         * @param {Object} post - The doctor visit post data.
         * @returns {string} HTML string for the post card.
         */
        function renderDoctorVisitPostCard(post) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-200 app-card">
                    <h4 class="font-bold text-blue-800">${post.doctorName}</h4>
                    ${post.doctorContactNumber ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Contact:</span> ${post.doctorContactNumber}</p>` : ''}
                    ${post.doctorAttendanceNumber ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Attendance:</span> ${post.doctorAttendanceNumber}</p>` : ''}
                    <p class="text-gray-700 text-sm"><span class="font-semibold">Visit Time:</span> ${post.visitingTime}</p>
                    <p class="text-gray-700 text-sm"><span class="font-semibold">Date:</span> ${new Date(post.visitDate).toLocaleDateString()}</p>
                    ${post.location ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Location:</span> ${post.location}</p>` : ''}
                    ${post.notes ? `<p class="text-gray-600 text-xs mt-1">Notes: ${post.notes}</p>` : ''}
                    <p class="text-gray-500 text-xs mt-2">Posted by: <span class="font-mono break-all">${post.postedByUserId}</span> on ${new Date(post.createdAt).toLocaleDateString()}</p>
                    ${isAdminUser ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="deleteDoctorVisitPost('${post.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"><i class="fas fa-trash-alt mr-1"></i> Delete</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }


        /**
         * Renders a travel post card.
         * @param {Object} post - The travel post data.
         * @returns {string} HTML string for the travel post card.
         */
        function renderTravelPostCard(post) {
            const postDate = new Date(post.travelDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to start of day

            // Filter out posts older than today if they are 'Offer Ride'
            // For 'Need Ride', they might still be relevant if not fulfilled
            // For simplicity in this client-side filter, we'll hide all past dates.
            if (postDate < today) {
                return ''; // Don't render past posts
            }

            let seatsInfo = '';
            if (post.travelType === 'Offer Ride') {
                seatsInfo = `<p class="text-gray-700 text-sm"><span class="font-semibold">Available Seats:</span> ${post.availableSeats || 'N/A'}</p>`;
            }

            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200 app-card">
                    <h4 class="font-bold text-indigo-800">${post.travelType} - ${post.travelOrigin} to ${post.travelDestination}</h4>
                    <p class="text-gray-700 text-sm">Date: ${new Date(post.travelDate).toLocaleDateString()} at ${post.travelTime}</p>
                    ${seatsInfo}
                    ${post.travelPurpose ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Purpose:</span> ${post.travelPurpose}</p>` : ''}
                    ${post.travelNotes ? `<p class="text-gray-700 text-sm"><span class="font-semibold">Notes:</span> ${post.travelNotes}</p>` : ''}
                    <p class="text-gray-700 text-sm">Contact: ${post.travelContactNumber}</p>
                    <div class="mt-2 flex gap-2">
                        <a href="tel:${post.travelContactNumber}" class="text-blue-500 hover:underline text-xs"><i class="fas fa-phone-alt mr-1"></i> Call</a>
                        <a href="https://wa.me/${post.travelContactNumber}" target="_blank" class="text-green-500 hover:underline text-xs"><i class="fab fa-whatsapp mr-1"></i> WhatsApp</a>
                    </div>
                    <p class="text-gray-500 text-xs mt-2">Posted by: <span class="font-mono break-all">${post.postedByUserId}</span></p>
                </div>
            `;
        }


        /**
         * Renders a volunteer card.
         * @param {Object} volunteer - The volunteer data.
         * @returns {string} HTML string for the volunteer card.
         */
        function renderVolunteerCard(volunteer) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-yellow-200 app-card">
                    <h4 class="font-bold text-yellow-800">${volunteer.fullName}</h4>
                    <p class="text-gray-700 text-sm">Phone: ${volunteer.phoneNumber}</p>
                    <p class="text-gray-700 text-sm">Skills: ${volunteer.skills.join(', ')}</p>
                    <div class="mt-2 flex gap-2">
                        <a href="tel:${volunteer.phoneNumber}" class="text-blue-500 hover:underline text-xs"><i class="fas fa-phone-alt mr-1"></i> Call</a>
                        <a href="https://wa.me/${volunteer.phoneNumber}" target="_blank" class="text-green-500 hover:underline text-xs"><i class="fab fa-whatsapp mr-1"></i> WhatsApp</a>
                    </div>
                </div>
            `;
        }

        /**
         * Renders an event card.
         * @param {Object} event - The event data.
         * @returns {string} HTML string for the event card.
         */
        function renderEventCard(event) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-teal-200 app-card">
                    <h4 class="font-bold text-teal-800">${event.eventName}</h4>
                    <p class="text-gray-700 text-sm">${event.description}</p>
                    <p class="text-gray-600 text-xs mt-1">Date: ${new Date(event.eventDate).toLocaleDateString()}</p>
                    <p class="text-gray-600 text-xs">Location: ${event.eventLocation}</p>
                    ${event.mapLink ? `<a href="${event.mapLink}" target="_blank" class="text-blue-500 hover:underline text-xs mt-1 block"><i class="fas fa-map-marker-alt mr-1"></i> View on Map</a>` : ''}
                </div>
            `;
        }

        /**
         * Renders a community post card.
         * @param {Object} post - The community post data.
         * @returns {string} HTML string for the post card.
         */
        function renderCommunityPostCard(post) {
            return `
                <div class="bg-white p-5 rounded-lg shadow-md border border-orange-200 app-card">
                    <p class="text-gray-800 mb-2">${post.postContent}</p>
                    ${post.imageLink ? `<img src="${post.imageLink}" alt="Post Image" class="w-full h-auto rounded-lg mt-2 mb-3 max-h-64 object-cover">` : ''}
                    <p class="text-gray-600 text-xs">Posted by: <span class="font-mono break-all">${post.postedByUserId}</span> on ${new Date(post.createdAt).toLocaleDateString()}</p>
                </div>
            `;
        }

        /**
         * Renders an admin message card for a specific user.
         * @param {Object} message - The admin message data.
         * @returns {string} HTML string for the message card.
         */
        function renderAdminMessageCard(message) {
            return `
                <div class="bg-yellow-50 p-4 rounded-lg shadow-sm border border-yellow-200 app-card">
                    <h4 class="font-bold text-yellow-800">${message.subject}</h4>
                    <p class="text-gray-700 text-sm">${message.messageContent}</p>
                    <p class="text-gray-500 text-xs mt-2">Sent by Admin on ${new Date(message.sentAt).toLocaleDateString()}</p>
                </div>
            `;
        }


        // --- Firebase Initialization and Auth ---

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebaseAndAuth() {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                storage = getStorage(firebaseApp); // Firebase Storage is now initialized

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthenticated = true;
                        const userIdDisplay = document.getElementById('userIdDisplay');
                        if (userIdDisplay) { // Null check added
                            userIdDisplay.innerText = userId;
                        }
                        isAdminUser = ADMIN_USER_IDS.includes(userId); // Set admin status
                        console.log("Authenticated with userId:", userId, "Is Admin:", isAdminUser);
                        // Once authenticated, start listening for data and update UI visibility
                        updateUIVisibility();
                        setupFirestoreListeners();
                    } else {
                        userId = null;
                        isAuthenticated = false;
                        console.log("Not authenticated.");
                        updateUIVisibility(); // Hide authenticated content
                        // No anonymous sign-in or custom token sign-in here, only email/password
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
                showMessage('Error!', 'Issue initializing Firebase or during login: ' + error.message);
            }
        }

        /**
         * Updates the visibility of sections based on authentication and admin status.
         */
        function updateUIVisibility() {
            const authSection = document.getElementById('authSection');
            const authenticatedContent = document.getElementById('authenticatedContent');
            const adminPanelSection = document.getElementById('adminPanelSection');
            const addEventFormContainer = document.getElementById('addEventFormContainer');
            const addPostFormContainer = document.getElementById('addPostFormContainer');
            const donationAccountsSection = document.getElementById('donationAccountsSection');
            const adminMessageUserSection = document.getElementById('adminMessageUserSection');

            if (isAuthenticated) {
                if (authSection) authSection.classList.add('hidden'); // Null check added
                if (authenticatedContent) authenticatedContent.classList.remove('hidden'); // Null check added
            } else {
                if (authSection) authSection.classList.remove('hidden'); // Null check added
                if (authenticatedContent) authenticatedContent.classList.add('hidden'); // Null check added
            }

            if (adminPanelSection) { // Null check added
                if (isAdminUser) {
                    adminPanelSection.classList.remove('hidden');
                } else {
                    adminPanelSection.classList.add('hidden');
                }
            }
            if (addEventFormContainer) { // Null check added
                if (isAdminUser) {
                    addEventFormContainer.classList.remove('hidden');
                } else {
                    addEventFormContainer.classList.add('hidden');
                }
            }
            if (addPostFormContainer) { // Null check added
                if (isAdminUser) {
                    addPostFormContainer.classList.remove('hidden');
                } else {
                    addPostFormContainer.classList.add('hidden');
                }
            }
            if (donationAccountsSection) { // Null check added
                if (isAdminUser) {
                    donationAccountsSection.classList.remove('hidden');
                } else {
                    donationAccountsSection.classList.add('hidden');
                }
            }
            if (adminMessageUserSection) { // Null check added
                if (isAdminUser) {
                    adminMessageUserSection.classList.remove('hidden');
                } else {
                    adminMessageUserSection.classList.add('hidden');
                }
            }
            // All other sections (self-registration, help request, blood request, samples request, doctor visit info, volunteer, events list, community feed list, message admin, emergency) are visible to all authenticated users.
        }

        // --- Login/Registration Logic ---
        document.getElementById('showRegisterFormLink')?.addEventListener('click', (e) => { // Null check added
            e.preventDefault();
            document.getElementById('loginForm')?.classList.add('hidden'); // Null check added
            document.getElementById('registerForm')?.classList.remove('hidden'); // Null check added
        });

        document.getElementById('showLoginFormLink')?.addEventListener('click', (e) => { // Null check added
            e.preventDefault();
            document.getElementById('registerForm')?.classList.add('hidden'); // Null check added
            document.getElementById('loginForm')?.classList.remove('hidden'); // Null check added
        });

        document.getElementById('loginForm')?.addEventListener('submit', async (e) => { // Null check added
            e.preventDefault();
            const email = document.getElementById('loginEmail')?.value; // Null check added
            const password = document.getElementById('loginPassword')?.value; // Null check added

            if (!email || !password) {
                showMessage('Error', 'Please enter both email and password.');
                return;
            }

            try {
                // reCAPTCHA verification (backend endpoint needed for this in a real app)
                // For client-side only, you might remove this or simulate success.
                // const token = await grecaptcha.execute('YOUR_RECAPTCHA_SITE_KEY', { action: 'login' });
                // const response = await fetch('/verify-recaptcha', { // You'll need a backend endpoint for this
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ token })
                // });
                // const data = await response.json();

                // if (!data.success) {
                //     showMessage('Verification Failed', 'reCAPTCHA verification failed. Please try again.');
                //     return;
                // }

                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Success', 'Logged in successfully!');
                // UI will update via onAuthStateChanged listener
            } catch (error) {
                console.error("Login error:", error);
                showMessage('Login Failed', error.message);
            }
        });

        document.getElementById('registerForm')?.addEventListener('submit', async (e) => { // Null check added
            e.preventDefault();
            const email = document.getElementById('registerEmail')?.value; // Null check added
            const password = document.getElementById('registerPassword')?.value; // Null check added
            const confirmPassword = document.getElementById('confirmPassword')?.value; // Null check added

            if (!email || !password || !confirmPassword) {
                showMessage('Error', 'Please fill all registration fields.');
                return;
            }
            if (password !== confirmPassword) {
                showMessage('Error', 'Passwords do not match.');
                return;
            }
            if (password.length < 6) {
                showMessage('Error', 'Password should be at least 6 characters.');
                return;
            }

            try {
                // reCAPTCHA verification (backend endpoint needed for this in a real app)
                // For client-side only, you might remove this or simulate success.
                // const token = await grecaptcha.execute('YOUR_RECAPTCHA_SITE_KEY', { action: 'register' });
                // const response = await fetch('/verify-recaptcha', { // You'll need a backend endpoint for this
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ token })
                // });
                // const data = await response.json();

                // if (!data.success) {
                //     showMessage('Verification Failed', 'reCAPTCHA verification failed. Please try again.');
                //     return;
                // }

                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('Success', 'Account created successfully! You are now logged in.');
                // UI will update via onAuthStateChanged listener
            } catch (error) {
                console.error("Registration error:", error);
                showMessage('Registration Failed', error.message);
            }
        });

        window.logoutUser = async function() {
            try {
                await signOut(auth);
                showMessage('Logged Out', 'You have been successfully logged out.');
                // UI will update via onAuthStateChanged listener
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('Logout Failed', error.message);
            }
        };


        /**
         * Sets up real-time listeners for Firestore collections.
         * This function is called once authentication is ready.
         */
        function setupFirestoreListeners() {
            if (!userId) { // Check for userId instead of isAuthenticated directly
                console.warn("User ID not available, cannot set up Firestore listeners.");
                return;
            }

            // Listener for all registered community members (Public Data) for Admin Panel
            const membersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members`);
            onSnapshot(membersColRef, (snapshot) => {
                const members = [];
                snapshot.forEach(doc => {
                    members.push({ id: doc.id, ...doc.data() });
                });
                // Sort by creation date (newest first)
                members.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

                // Store all members globally for filtering
                window.allMembers = members;
                applyAdminFilters(); // Apply filters initially
                console.log("Registered members updated for admin view.");
            }, (error) => {
                console.error("Error fetching members for admin:", error);
                showMessage('Error!', 'Issue loading members for admin: ' + error.message);
            });

            // Listener for Volunteers
            const volunteersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_volunteers`);
            onSnapshot(volunteersColRef, (snapshot) => {
                const volunteers = [];
                snapshot.forEach(doc => {
                    volunteers.push({ id: doc.id, ...doc.data() });
                });
                volunteers.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

                const volunteersContainer = document.getElementById('volunteersContainer');
                const noVolunteersMessage = document.getElementById('noVolunteersMessage');

                if (volunteersContainer && noVolunteersMessage) { // Null check added
                    volunteersContainer.innerHTML = '';
                    if (volunteers.length === 0) {
                        noVolunteersMessage.classList.remove('hidden');
                    } else {
                        noVolunteersMessage.classList.add('hidden');
                        volunteers.forEach(volunteer => {
                            volunteersContainer.innerHTML += renderVolunteerCard(volunteer);
                        });
                    }
                }
                console.log("Volunteers list updated.");
            }, (error) => {
                console.error("Error fetching volunteers:", error);
                showMessage('Error!', 'Issue loading volunteers: ' + error.message);
            });

            // Listener for Events
            const eventsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_events`);
            onSnapshot(eventsColRef, (snapshot) => {
                const events = [];
                snapshot.forEach(doc => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                // Sort by event date (upcoming first)
                events.sort((a, b) => (new Date(a.eventDate) - new Date(b.eventDate)));

                const eventsList = document.getElementById('eventsList');
                const noEventsMessage = document.getElementById('noEventsMessage');

                if (eventsList && noEventsMessage) { // Null check added
                    eventsList.innerHTML = '';
                    if (events.length === 0) {
                        noEventsMessage.classList.remove('hidden');
                    } else {
                        noEventsMessage.classList.add('hidden');
                        events.forEach(event => {
                            eventsList.innerHTML += renderEventCard(event);
                        });
                    }
                }
                console.log("Events list updated.");
            }, (error) => {
                console.error("Error fetching events:", error);
                showMessage('Error!', 'Issue loading events: ' + error.message);
            });

            // Listener for Community Feed Posts
            const communityPostsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_community_posts`);
            onSnapshot(communityPostsColRef, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                // Sort by creation date (newest first)
                posts.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

                const communityFeedList = document.getElementById('communityFeedList');
                const noPostsMessage = document.getElementById('noPostsMessage');

                if (communityFeedList && noPostsMessage) { // Null check added
                    communityFeedList.innerHTML = '';
                    if (posts.length === 0) {
                        noPostsMessage.classList.remove('hidden');
                    } else {
                        noPostsMessage.classList.add('hidden');
                        posts.forEach(post => {
                            communityFeedList.innerHTML += renderCommunityPostCard(post);
                        });
                    }
                }
                console.log("Community feed updated.");
            }, (error) => {
                console.error("Error fetching community posts:", error);
                showMessage('Error!', 'Issue loading community feed: ' + error.message);
            });

            // Listener for Donation Accounts
            const donationAccountsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_donation_accounts`);
            onSnapshot(donationAccountsColRef, (snapshot) => {
                const accounts = [];
                snapshot.forEach(doc => {
                    accounts.push({ id: doc.id, ...doc.data() });
                });
                // Sort by creation date (newest first)
                accounts.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

                const donationAccountsListDiv = document.getElementById('currentDonationAccountsList');
                const noDonationAccountsMessage = document.getElementById('noDonationAccountsMessage');

                if (donationAccountsListDiv && noDonationAccountsMessage) { // Null check added
                    donationAccountsListDiv.innerHTML = '';
                    if (accounts.length === 0) {
                        noDonationAccountsMessage.classList.remove('hidden');
                    } else {
                        noDonationAccountsMessage.classList.add('hidden');
                        accounts.forEach(account => {
                            donationAccountsListDiv.innerHTML += renderDonationAccountCard(account, isAdminUser);
                        });
                    }
                }
                console.log("Donation accounts updated.");
            }, (error) => {
                console.error("Error fetching donation accounts:", error);
                showMessage('Error!', 'Issue loading donation accounts: ' + error.message);
            });

            // Listener for Samples Requests
            const samplesRequestsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_sample_requests`);
            onSnapshot(samplesRequestsColRef, (snapshot) => {
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => (b.requestDate || '').localeCompare(a.requestDate || ''));

                const samplesContainer = document.getElementById('samplesContainer');
                const noSamplesMessage = document.getElementById('noSamplesMessage');

                if (samplesContainer && noSamplesMessage) { // Null check added
                    samplesContainer.innerHTML = '';
                    if (requests.length === 0) {
                        noSamplesMessage.classList.remove('hidden');
                    } else {
                        noSamplesMessage.classList.add('hidden');
                        requests.forEach(request => {
                            samplesContainer.innerHTML += renderSampleRequestCard(request);
                        });
                    }
                }
                console.log("Sample requests updated.");
            }, (error) => {
                console.error("Error fetching sample requests:", error);
                showMessage('Error!', 'Issue loading sample requests: ' + error.message);
            });

            // Listener for Doctor Visit Posts
            const doctorVisitPostsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_doctor_visits`);
            onSnapshot(doctorVisitPostsColRef, (snapshot) => {
                const posts = [];
                const now = new Date();
                now.setHours(0, 0, 0, 0); // Normalize to start of day for comparison

                snapshot.forEach(doc => {
                    const postData = doc.data();
                    const postDate = new Date(postData.visitDate);
                    postDate.setHours(0, 0, 0, 0); // Normalize post date to start of day

                    // Only show posts for today or future dates
                    if (postDate >= now) {
                        posts.push({ id: doc.id, ...postData });
                    }
                });
                posts.sort((a, b) => {
                    const dateA = new Date(`${a.visitDate}T${a.visitingTime}`);
                    const dateB = new Date(`${b.visitDate}T${b.visitingTime}`);
                    return dateA - dateB;
                }); // Sort by date and time

                const doctorVisitPostsListDiv = document.getElementById('doctorVisitPostsList');
                const noDoctorVisitPostsMessage = document.getElementById('noDoctorVisitPostsMessage');

                if (doctorVisitPostsListDiv && noDoctorVisitPostsMessage) { // Null check added
                    doctorVisitPostsListDiv.innerHTML = '';
                    if (posts.length === 0) {
                        noDoctorVisitPostsMessage.classList.remove('hidden');
                    } else {
                        noDoctorVisitPostsMessage.classList.add('hidden');
                        posts.forEach(post => {
                            doctorVisitPostsListDiv.innerHTML += renderDoctorVisitPostCard(post);
                        });
                    }
                }
                console.log("Doctor visit posts updated.");
            }, (error) => {
                console.error("Error fetching doctor visit posts:", error);
                showMessage('Error!', 'Issue loading doctor visit posts: ' + error.message);
            });


            // Listener for Daily Travel Posts
            const travelPostsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_travel_posts`);
            onSnapshot(travelPostsColRef, (snapshot) => {
                const posts = [];
                const now = new Date();
                now.setHours(0,0,0,0); // Normalize to start of day for comparison

                snapshot.forEach(doc => {
                    const postData = doc.data();
                    const postDate = new Date(`${postData.travelDate}T${postData.travelTime}`); // Include time for more precise expiry

                    // Only show posts that are in the future or today and haven't passed their time
                    if (postDate >= now) {
                        posts.push({ id: doc.id, ...postData });
                    }
                });
                // Sort by travel date and time
                posts.sort((a, b) => {
                    const dateA = new Date(`${a.travelDate}T${a.travelTime}`);
                    const dateB = new Date(`${b.travelDate}T${b.travelTime}`);
                    return dateA - dateB;
                });

                const travelPostsListDiv = document.getElementById('travelPostsList');
                const noTravelPostsMessage = document.getElementById('noTravelPostsMessage');

                if (travelPostsListDiv && noTravelPostsMessage) { // Null check added
                    travelPostsListDiv.innerHTML = '';
                    if (posts.length === 0) {
                        noTravelPostsMessage.classList.remove('hidden');
                    } else {
                        noTravelPostsMessage.classList.add('hidden');
                        posts.forEach(post => {
                            travelPostsListDiv.innerHTML += renderTravelPostCard(post);
                        });
                    }
                }
                console.log("Daily travel posts updated.");
            }, (error) => {
                console.error("Error fetching daily travel posts:", error);
                showMessage('Error!', 'Issue loading daily travel posts: ' + error.message);
            });

            // Listener for Admin Messages to Users (Private to each user)
            const adminMessagesColRef = collection(db, `artifacts/${appId}/users/${userId}/admin_messages`);
            onSnapshot(adminMessagesColRef, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                messages.sort((a, b) => (b.sentAt || '').localeCompare(a.sentAt || ''));

                // You would need a section in your HTML to display these messages to the user.
                // For now, we'll just log them.
                console.log("Admin messages for current user:", messages);
                // Example: display in a dedicated section or notification
                // const userMessagesContainer = document.getElementById('userMessagesContainer');
                // if (userMessagesContainer) {
                //     userMessagesContainer.innerHTML = '';
                //     if (messages.length === 0) {
                //         userMessagesContainer.innerHTML = '<p class="text-gray-500">No messages from Admin yet.</p>';
                //     } else {
                //         messages.forEach(msg => {
                //             userMessagesContainer.innerHTML += renderAdminMessageCard(msg);
                //         });
                //     }
                // }
            }, (error) => {
                console.error("Error fetching admin messages for user:", error);
            });
        }

        /**
         * Applies filters and search query to the admin members list.
         */
        window.applyAdminFilters = function() {
            const searchQuery = document.getElementById('adminSearchQuery')?.value.toLowerCase() || ''; // Null check added
            const filterStatus = document.getElementById('adminFilterStatus')?.value || 'All'; // Null check added
            const filterBloodGroup = document.getElementById('adminFilterBloodGroup')?.value || 'All'; // Null check added

            let filteredMembers = window.allMembers;

            if (searchQuery) {
                filteredMembers = filteredMembers.filter(member =>
                    member.fullName.toLowerCase().includes(searchQuery) ||
                    member.phoneNumber.includes(searchQuery) ||
                    (member.fatherName && member.fatherName.toLowerCase().includes(searchQuery)) ||
                    (member.emergencyContactNumber && member.emergencyContactNumber.includes(searchQuery)) ||
                    (member.pharmaceuticalCompanyName && member.pharmaceuticalCompanyName.toLowerCase().includes(searchQuery))
                );
            }

            if (filterStatus !== 'All') {
                filteredMembers = filteredMembers.filter(member => (member.status || 'Pending') === filterStatus);
            }

            if (filterBloodGroup !== 'All') {
                filteredMembers = filteredMembers.filter(member => member.bloodGroup === filterBloodGroup);
            }

            const adminMembersListDiv = document.getElementById('adminMembersList');
            const noAdminMembersMessage = document.getElementById('noAdminMembersMessage');

            if (adminMembersListDiv && noAdminMembersMessage) { // Null check added
                adminMembersListDiv.innerHTML = '';
                if (filteredMembers.length === 0) {
                    noAdminMembersMessage.classList.remove('hidden');
                } else {
                    noAdminMembersMessage.classList.add('hidden');
                    filteredMembers.forEach(member => {
                        adminMembersListDiv.innerHTML += renderAdminMemberCard(member);
                    });
                }
            }
        };

        // --- File Upload Preview for Donation Screenshot ---
        document.getElementById('donationScreenshotFile')?.addEventListener('change', function(event) { // Null check added
            const file = event.target.files[0];
            const previewContainer = document.getElementById('screenshotPreviewContainer');
            const previewImage = document.getElementById('screenshotPreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (previewImage) previewImage.src = e.target.result; // Null check added
                    if (previewContainer) previewContainer.classList.remove('hidden'); // Null check added
                };
                reader.readAsDataURL(file);
            } else {
                if (previewImage) previewImage.src = '#'; // Null check added
                if (previewContainer) previewContainer.classList.add('hidden'); // Null check added
            }
        });

        // --- File Upload Preview for Profile Picture ---
        document.getElementById('profilePictureFile')?.addEventListener('change', function(event) { // Null check added
            const file = event.target.files[0];
            const previewContainer = document.getElementById('profilePicturePreviewContainer');
            const previewImage = document.getElementById('profilePicturePreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (previewImage) previewImage.src = e.target.result; // Null check added
                    if (previewContainer) previewContainer.classList.remove('hidden'); // Null check added
                };
                reader.readAsDataURL(file);
            } else {
                if (previewImage) previewImage.src = '#'; // Null check added
                if (previewContainer) previewContainer.classList.add('hidden'); // Null check added
            }
        });


        /**
         * Uploads a file to Firebase Storage and returns its download URL.
         * @param {File} file - The file to upload.
         * @param {string} uploadPath - The path in Firebase Storage (e.g., 'donation_screenshots').
         * @param {string} memberId - The ID of the member (for path organization).
         * @param {HTMLElement} statusDiv - The div to display upload status.
         * @returns {Promise<string|null>} The download URL of the uploaded file, or null if failed.
         */
        async function uploadFileToStorage(file, uploadPath, memberId, statusDiv) {
            if (!file) return null;

            const storageRef = ref(storage, `artifacts/${appId}/public/${uploadPath}/${memberId}/${Date.now()}_${file.name}`);

            if (statusDiv) { // Null check added
                statusDiv.innerText = 'Uploading...';
                statusDiv.classList.remove('text-red-500', 'text-green-500');
                statusDiv.classList.add('text-blue-500');
            }


            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                if (statusDiv) { // Null check added
                    statusDiv.innerText = 'Upload successful!';
                    statusDiv.classList.remove('text-blue-500');
                    statusDiv.classList.add('text-green-500');
                }
                return downloadURL;
            } catch (error) {
                console.error(`Error uploading file to ${uploadPath}:`, error);
                if (statusDiv) { // Null check added
                    statusDiv.innerText = `Upload failed: ${error.message}`;
                    statusDiv.classList.remove('text-blue-500');
                    statusDiv.classList.add('text-red-500');
                }
                showMessage('Upload Error', `Failed to upload ${uploadPath.replace('_', ' ')}: ` + error.message);
                return null;
            }
        }


        // --- Member Registration / Self-Add ---

        /**
         * Adds a new community member to Firestore.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('addMemberForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to register a member.');
                return;
            }

            const fullName = document.getElementById('fullName')?.value.trim(); // Null check added
            const fatherName = document.getElementById('fatherName')?.value.trim(); // Null check added
            const phoneNumber = document.getElementById('phoneNumber')?.value.trim(); // Null check added
            const emergencyContactNumber = document.getElementById('emergencyContactNumber')?.value.trim(); // Null check added
            const emergencyContactRelationship = document.getElementById('emergencyContactRelationship')?.value.trim(); // Null check added
            const address = document.getElementById('address')?.value.trim(); // Null check added
            const bloodGroup = document.getElementById('bloodGroup')?.value; // Null check added
            const pharmaceuticalCompanyName = document.getElementById('pharmaceuticalCompanyName')?.value.trim(); // Null check added
            const designationInCompany = document.getElementById('designationInCompany')?.value; // Null check added
            const donationType = document.getElementById('donationType')?.value; // Null check added
            const donationDate = document.getElementById('donationDate')?.value; // Null check added
            const donationScreenshotFile = document.getElementById('donationScreenshotFile')?.files[0]; // Null check added
            const profilePictureFile = document.getElementById('profilePictureFile')?.files[0]; // Null check added
            const email = document.getElementById('email')?.value.trim(); // Null check added
            const gender = document.getElementById('gender')?.value; // Null check added

            if (!fullName || !phoneNumber) {
                showMessage('Error', 'Please enter Full Name and Phone Number.');
                return;
            }

            // Basic file type validation for images
            if (donationScreenshotFile && !donationScreenshotFile.type.startsWith('image/')) {
                showMessage('Invalid File Type', 'Please upload an image file for the donation screenshot.');
                return;
            }
            if (profilePictureFile && !profilePictureFile.type.startsWith('image/')) {
                showMessage('Invalid File Type', 'Please upload an image file for the profile picture.');
                return;
            }

            try {
                // Check if a member with this phone number already exists
                const membersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members`);
                let existingMemberQuery = query(membersColRef, where("phoneNumber", "==", phoneNumber));
                let querySnapshot = await getDocs(existingMemberQuery);

                if (!querySnapshot.empty) {
                    showMessage('Already Registered', 'A member with this phone number is already registered.');
                    return;
                }

                const newMemberRef = await addDoc(membersColRef, {
                    fullName: fullName,
                    fatherName: fatherName || null,
                    phoneNumber: phoneNumber,
                    emergencyContactNumber: emergencyContactNumber || null,
                    emergencyContactRelationship: emergencyContactRelationship || null,
                    address: address || null,
                    bloodGroup: bloodGroup || null,
                    pharmaceuticalCompanyName: pharmaceuticalCompanyName || null,
                    designationInCompany: designationInCompany || null,
                    email: email || null,
                    gender: gender || null,
                    addedByUserId: userId, // Who added this record
                    createdAt: new Date().toISOString(),
                    status: 'Pending', // Default status for new registrations
                    adminNotes: '', // Initialize admin notes
                    profilePictureUrl: null // Will be updated after upload
                });

                let screenshotUrl = null;
                let profilePictureUrl = null;

                // Upload files to Storage AFTER member is created to get memberId for storage path
                if (donationScreenshotFile) {
                    screenshotUrl = await uploadFileToStorage(donationScreenshotFile, 'donation_screenshots', newMemberRef.id, document.getElementById('screenshotUploadStatus'));
                }
                if (profilePictureFile) {
                    profilePictureUrl = await uploadFileToStorage(profilePictureFile, 'profile_pictures', newMemberRef.id, document.getElementById('profilePictureUploadStatus'));
                    if (profilePictureUrl) {
                        // Update the member document with the profile picture URL
                        await updateDoc(newMemberRef, { profilePictureUrl: profilePictureUrl });
                    }
                }

                // If donation details are provided, add them as a donation proof sub-document
                if (donationType && donationDate) {
                    const donationProofsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members/${newMemberRef.id}/donation_proofs`);
                    await addDoc(donationProofsColRef, {
                        type: donationType,
                        date: donationDate,
                        description: `Donation of type: ${donationType} on ${donationDate}`,
                        screenshotLink: screenshotUrl,
                        submittedAt: new Date().toISOString(),
                        status: "Pending", // Default status for new proofs
                        submittedByUserId: userId, // Who submitted this proof
                        memberId: newMemberRef.id // Add memberId to proof for easier access in rendering
                    });
                }

                showMessage('Success!', 'New member successfully registered. Status is Pending verification.');
                document.getElementById('addMemberForm')?.reset(); // Null check added // Clear form
                // Clear file inputs and previews
                const donationScreenshotFileElement = document.getElementById('donationScreenshotFile');
                const screenshotPreviewContainer = document.getElementById('screenshotPreviewContainer');
                const screenshotPreview = document.getElementById('screenshotPreview');
                const screenshotUploadStatus = document.getElementById('screenshotUploadStatus');

                if (donationScreenshotFileElement) donationScreenshotFileElement.value = ''; // Null check added
                if (screenshotPreviewContainer) screenshotPreviewContainer.classList.add('hidden'); // Null check added
                if (screenshotPreview) screenshotPreview.src = '#'; // Null check added
                if (screenshotUploadStatus) screenshotUploadStatus.innerText = ''; // Null check added

                const profilePictureFileElement = document.getElementById('profilePictureFile');
                const profilePicturePreviewContainer = document.getElementById('profilePicturePreviewContainer');
                const profilePicturePreview = document.getElementById('profilePicturePreview');
                const profilePictureUploadStatus = document.getElementById('profilePictureUploadStatus');

                if (profilePictureFileElement) profilePictureFileElement.value = ''; // Null check added
                if (profilePicturePreviewContainer) profilePicturePreviewContainer.classList.add('hidden'); // Null check added
                if (profilePicturePreview) profilePicturePreview.src = '#'; // Null check added
                if (profilePictureUploadStatus) profilePictureUploadStatus.innerText = ''; // Null check added


            } catch (error) {
                console.error("Error adding member: ", error);
                showMessage('Error!', 'Issue adding member: ' + error.message);
            }
        });

        // --- Admin Panel Functionality ---

        /**
         * Shows the detailed modal for a selected member.
         * @param {string} memberId - The ID of the member to display.
         */
        window.showMemberDetails = async function(memberId) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to view full member details.');
                return;
            }
            currentAdminViewMemberId = memberId;
            const memberRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_members`, memberId);

            try {
                const memberSnap = await getDoc(memberRef);
                if (memberSnap.exists()) {
                    const memberData = memberSnap.data();
                    // Null checks added for all elements before accessing their properties
                    document.getElementById('modalMemberName').innerText = memberData.fullName || '';
                    document.getElementById('modalMemberFullName').innerText = memberData.fullName || '';
                    document.getElementById('modalMemberFatherName').innerText = memberData.fatherName || 'N/A';
                    document.getElementById('modalMemberPhone').innerText = memberData.phoneNumber || '';
                    document.getElementById('modalMemberCall').href = `tel:${memberData.phoneNumber}`;
                    document.getElementById('modalMemberWhatsApp').href = `https://wa.me/${memberData.phoneNumber}`;
                    document.getElementById('modalMemberEmergencyContact').innerText = `${memberData.emergencyContactNumber || 'N/A'} ${memberData.emergencyContactRelationship ? `(${memberData.emergencyContactRelationship})` : ''}`;
                    document.getElementById('modalMemberAddress').innerText = memberData.address || 'N/A';
                    document.getElementById('modalMemberBloodGroup').innerText = memberData.bloodGroup || 'N/A';
                    document.getElementById('modalMemberCompanyName').innerText = memberData.pharmaceuticalCompanyName || 'N/A';
                    document.getElementById('modalMemberDesignation').innerText = memberData.designationInCompany || 'N/A';
                    document.getElementById('modalMemberEmail').innerText = memberData.email || 'N/A';
                    document.getElementById('modalMemberGender').innerText = memberData.gender || 'N/A';
                    document.getElementById('modalMemberAddedBy').innerText = memberData.addedByUserId || '';
                    document.getElementById('modalMemberRegDate').innerText = new Date(memberData.createdAt).toLocaleDateString();
                    document.getElementById('modalMemberStatus').innerText = memberData.status || 'Pending';
                    document.getElementById('modalAdminNotes').value = memberData.adminNotes || '';

                    // Display profile picture
                    const profilePicElement = document.getElementById('modalProfilePicture');
                    if (profilePicElement) { // Null check added
                        profilePicElement.src = memberData.profilePictureUrl || 'https://placehold.co/100x100/aabbcc/ffffff?text=No+Photo';
                    }


                    // Fetch and display donation proofs
                    const donationProofsListDiv = document.getElementById('modalDonationProofsList');
                    const noModalDonationProofs = document.getElementById('noModalDonationProofs');
                    const donationImpactSummary = document.getElementById('donationImpactSummary');

                    if (donationProofsListDiv && noModalDonationProofs && donationImpactSummary) { // Null check added
                        donationProofsListDiv.innerHTML = '';
                        noModalDonationProofs.classList.remove('hidden');
                        donationImpactSummary.classList.add('hidden'); // Hide summary on new open
                    }


                    const donationProofsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members/${memberId}/donation_proofs`);
                    const proofsSnapshot = await getDocs(donationProofsColRef);
                    let verifiedDonationsCount = 0;
                    if (!proofsSnapshot.empty) {
                        if (noModalDonationProofs) noModalDonationProofs.classList.add('hidden'); // Null check added
                        proofsSnapshot.forEach(proofDoc => {
                            const proofData = proofDoc.data();
                            // Pass memberId to render function for status update buttons
                            if (donationProofsListDiv) donationProofsListDiv.innerHTML += renderDonationProofCard({ ...proofData, id: proofDoc.id, memberId: memberId }); // Null check added
                            if (proofData.status === 'Verified') {
                                verifiedDonationsCount++;
                            }
                        });
                    }
                    const totalVerifiedDonations = document.getElementById('totalVerifiedDonations');
                    const modalDonorBadge = document.getElementById('modalDonorBadge');
                    if (totalVerifiedDonations) totalVerifiedDonations.innerText = `(${verifiedDonationsCount} Verified)`; // Null check added
                    if (modalDonorBadge) modalDonorBadge.innerText = getDonorBadge(verifiedDonationsCount); // Null check added


                    // Fetch and display assistance requests
                    const assistanceRequestsListDiv = document.getElementById('modalAssistanceRequestsList');
                    const noModalAssistanceRequests = document.getElementById('noModalAssistanceRequests');
                    if (assistanceRequestsListDiv && noModalAssistanceRequests) { // Null check added
                        assistanceRequestsListDiv.innerHTML = '';
                        noModalAssistanceRequests.classList.remove('hidden');
                    }


                    const assistanceRequestsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members/${memberId}/assistance_requests`);
                    const requestsSnapshot = await getDocs(assistanceRequestsColRef);
                    if (!requestsSnapshot.empty) {
                        if (noModalAssistanceRequests) noModalAssistanceRequests.classList.add('hidden'); // Null check added
                        requestsSnapshot.forEach(requestDoc => {
                            // Pass memberId to render function for status update buttons
                            if (assistanceRequestsListDiv) assistanceRequestsListDiv.innerHTML += renderAssistanceRequestCard({ ...requestDoc.data(), id: requestDoc.id, memberId: memberId }); // Null check added
                        });
                    }

                    // Fetch and display blood requests made by this member
                    const bloodRequestsListDiv = document.getElementById('modalBloodRequestsList');
                    const noModalBloodRequests = document.getElementById('noModalBloodRequests');
                    if (bloodRequestsListDiv && noModalBloodRequests) { // Null check added
                        bloodRequestsListDiv.innerHTML = '';
                        noModalBloodRequests.classList.remove('hidden');
                    }


                    const bloodRequestsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_blood_requests`);
                    const qBloodRequests = query(bloodRequestsColRef, where("requestedByUserId", "==", memberId));
                    const bloodRequestsSnapshot = await getDocs(qBloodRequests);
                    let fulfilledBloodRequestsCount = 0;
                    if (!bloodRequestsSnapshot.empty) {
                        if (noModalBloodRequests) noModalBloodRequests.classList.add('hidden'); // Null check added
                        bloodRequestsSnapshot.forEach(bloodRequestDoc => {
                            const bloodRequestData = bloodRequestDoc.data();
                            if (bloodRequestsListDiv) bloodRequestsListDiv.innerHTML += renderBloodRequestHistoryCard({ ...bloodRequestData, id: bloodRequestDoc.id }); // Null check added
                            if (bloodRequestData.status === 'Fulfilled') {
                                fulfilledBloodRequestsCount++;
                            }
                        });
                    }
                    const totalFulfilledBloodRequests = document.getElementById('totalFulfilledBloodRequests');
                    if (totalFulfilledBloodRequests) totalFulfilledBloodRequests.innerText = `(${fulfilledBloodRequestsCount} Fulfilled)`; // Null check added


                    const memberDetailsModal = document.getElementById('memberDetailsModal');
                    if (memberDetailsModal) { // Null check added
                        memberDetailsModal.classList.remove('hidden');
                    }
                } else {
                    showMessage('Not Found', 'Member not found.');
                }
            } catch (error) {
                console.error("Error fetching member details:", error);
                showMessage('Error!', 'Issue loading member details: ' + error.message);
            }
        };

        /**
         * Hides the member details modal.
         */
        window.hideMemberDetailsModal = function() {
            const memberDetailsModal = document.getElementById('memberDetailsModal');
            const donationImpactSummary = document.getElementById('donationImpactSummary');
            if (memberDetailsModal) { // Null check added
                memberDetailsModal.classList.add('hidden');
            }
            currentAdminViewMemberId = null;
            if (donationImpactSummary) { // Null check added
                donationImpactSummary.classList.add('hidden'); // Hide summary when closing
            }
        };

        /**
         * Updates the status of a member (Verified/Rejected).
         * @param {string} status - The new status to set ('Verified' or 'Rejected').
         */
        window.updateMemberStatus = async function(status) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to update member status.');
                return;
            }
            if (!currentAdminViewMemberId) {
                showMessage('Error', 'No member selected.');
                return;
            }

            try {
                const memberRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_members`, currentAdminViewMemberId);
                await updateDoc(memberRef, { status: status });
                showMessage('Success!', `Member status updated to ${status}.`);
                // No need to hide modal, it will refresh with new data
            } catch (error) {
                console.error("Error updating member status:", error);
                showMessage('Error!', 'Issue updating member status: ' + error.message);
            }
        };

        /**
         * Updates the status of a specific donation proof.
         * @param {string} memberId - The ID of the member.
         * @param {string} proofId - The ID of the donation proof.
         * @param {string} status - The new status ('Verified' or 'Rejected').
         */
        window.updateDonationProofStatus = async function(memberId, proofId, status) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to update donation proof status.');
                return;
            }
            try {
                const proofRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_members/${memberId}/donation_proofs`, proofId);
                await updateDoc(proofRef, { status: status });
                showMessage('Success!', `Donation proof status updated to ${status}.`);
                // Re-fetch member details to update modal and donor badge
                showMemberDetails(memberId);
            } catch (error) {
                console.error("Error updating donation proof status:", error);
                showMessage('Error!', 'Issue updating donation proof status: ' + error.message);
            }
        };

        /**
         * Updates the status of a specific assistance request.
         * @param {string} memberId - The ID of the member.
         * @param {string} requestId - The ID of the assistance request.
         * @param {string} status - The new status ('Approved', 'Under Review', 'Rejected', 'Fulfilled').
         */
        window.updateAssistanceRequestStatus = async function(memberId, requestId, status) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to update assistance request status.');
                return;
            }
            try {
                const requestRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_members/${memberId}/assistance_requests`, requestId);
                await updateDoc(requestRef, { status: status });
                showMessage('Success!', `Assistance request status updated to ${status}.`);
                // Re-fetch member details to update modal
                showMemberDetails(memberId);
            } catch (error) {
                console.error("Error updating assistance request status:", error);
                showMessage('Error!', 'Issue updating assistance request status: ' + error.message);
            }
        };

        /**
         * Updates the status of a specific blood request.
         * @param {string} requestId - The ID of the blood request.
         * @param {string} status - The new status ('Fulfilled' or 'Cancelled').
         */
        window.updateBloodRequestStatus = async function(requestId, status) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to update blood request status.');
                return;
            }
            try {
                const bloodRequestRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_blood_requests`, requestId);
                await updateDoc(bloodRequestRef, { status: status });
                showMessage('Success!', `Blood request status updated to ${status}.`);
                // Re-fetch member details to update modal
                if (currentAdminViewMemberId) { // Null check added
                    showMemberDetails(currentAdminViewMemberId);
                }
            } catch (error) {
                console.error("Error updating blood request status:", error);
                showMessage('Error!', 'Issue updating blood request status: ' + error.message);
            }
        };

        /**
         * Saves admin notes for the current member.
         */
        window.saveAdminNotes = async function() {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to save admin notes.');
                return;
            }
            if (!currentAdminViewMemberId) {
                showMessage('Error', 'No member selected.');
                return;
            }

            const modalAdminNotes = document.getElementById('modalAdminNotes');
            const adminNotes = modalAdminNotes ? modalAdminNotes.value.trim() : ''; // Null check added

            try {
                const memberRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_members`, currentAdminViewMemberId);
                await updateDoc(memberRef, { adminNotes: adminNotes });
                showMessage('Success!', 'Admin notes saved.');
            } catch (error) {
                console.error("Error saving admin notes:", error);
                showMessage('Error!', 'Issue saving admin notes: ' + error.message);
            }
        };

        /**
         * Deletes a community member from the modal.
         */
        window.deleteMemberFromModal = async function() {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to delete a member.');
                return;
            }
            if (!currentAdminViewMemberId) {
                showMessage('Error', 'No member selected for deletion.');
                return;
            }

            // Using custom modal instead of confirm()
            showMessage('Confirm Deletion', 'Are you sure you want to delete this member? This action cannot be undone. <br><br><button onclick="confirmDeleteMember()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Yes, Delete</button> <button onclick="hideMessage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 ml-2">Cancel</button>');
        };

        /**
         * Confirms and proceeds with member deletion.
         */
        window.confirmDeleteMember = async function() {
            hideMessage(); // Hide confirmation message

            try {
                const memberRef = doc(db, `artifacts/${appId}/public/data/smr_mardan_members`, currentAdminViewMemberId);
                await deleteDoc(memberRef);
                showMessage('Success!', 'Member successfully deleted.');
                hideMemberDetailsModal();
            } catch (error) {
                console.error("Error deleting member:", error);
                showMessage('Error!', 'Issue deleting member: ' + error.message);
            }
        };


        // --- Donation Accounts Management (Admin Only) ---
        document.getElementById('accountType')?.addEventListener('change', function() { // Null check added
            const accountType = this.value;
            const mobileAccountFields = document.getElementById('mobileAccountFields');
            const bankAccountFields = document.getElementById('bankAccountFields');

            if (mobileAccountFields) mobileAccountFields.classList.add('hidden'); // Null check added
            if (bankAccountFields) bankAccountFields.classList.add('hidden'); // Null check added

            // Clear fields when switching types
            const mobileAccountNumber = document.getElementById('mobileAccountNumber');
            const mobileAccountTitle = document.getElementById('mobileAccountTitle');
            const bankName = document.getElementById('bankName');
            const bankAccountNumber = document.getElementById('bankAccountNumber');
            const bankAccountTitle = document.getElementById('bankAccountTitle');

            if (mobileAccountNumber) mobileAccountNumber.value = ''; // Null check added
            if (mobileAccountTitle) mobileAccountTitle.value = ''; // Null check added
            if (bankName) bankName.value = ''; // Null check added
            if (bankAccountNumber) bankAccountNumber.value = ''; // Null check added
            if (bankAccountTitle) bankAccountTitle.value = ''; // Null check added


            if (accountType === 'EasyPaisa' || accountType === 'JazzCash' || accountType === 'UCash') {
                if (mobileAccountFields) mobileAccountFields.classList.remove('hidden'); // Null check added
            } else if (accountType === 'Bank Account') {
                if (bankAccountFields) bankAccountFields.classList.remove('hidden'); // Null check added
            }
        });

        document.getElementById('addDonationAccountForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to add donation accounts.');
                return;
            }

            const accountType = document.getElementById('accountType')?.value; // Null check added
            let accountData = {
                accountType: accountType,
                addedByUserId: userId,
                createdAt: new Date().toISOString()
            };

            if (accountType === 'EasyPaisa' || accountType === 'JazzCash' || accountType === 'UCash') {
                accountData.mobileAccountNumber = document.getElementById('mobileAccountNumber')?.value.trim(); // Null check added
                accountData.accountTitle = document.getElementById('mobileAccountTitle')?.value.trim(); // Null check added
                if (!accountData.mobileAccountNumber || !accountData.accountTitle) {
                    showMessage('Error', 'Please fill all mobile account details.');
                    return;
                }
            } else if (accountType === 'Bank Account') {
                accountData.bankName = document.getElementById('bankName')?.value.trim(); // Null check added
                accountData.bankAccountNumber = document.getElementById('bankAccountNumber')?.value.trim(); // Null check added
                accountData.accountTitle = document.getElementById('bankAccountTitle')?.value.trim(); // Null check added
                if (!accountData.bankName || !accountData.bankAccountNumber || !accountData.accountTitle) {
                    showMessage('Error', 'Please fill all bank account details.');
                    return;
                }
            } else {
                showMessage('Error', 'Please select an account type.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_donation_accounts`), accountData);
                showMessage('Success!', 'Donation account added successfully.');
                document.getElementById('addDonationAccountForm')?.reset(); // Null check added
                const mobileAccountFields = document.getElementById('mobileAccountFields');
                const bankAccountFields = document.getElementById('bankAccountFields');
                if (mobileAccountFields) mobileAccountFields.classList.add('hidden'); // Null check added
                if (bankAccountFields) bankAccountFields.classList.add('hidden'); // Null check added
            } catch (error) {
                console.error("Error adding donation account:", error);
                showMessage('Error!', 'Issue adding donation account: ' + error.message);
            }
        });

        window.editDonationAccount = async function(accountId) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to edit donation accounts.');
                return;
            }
            // For simplicity, this will just show a message. In a real app, you'd populate the form
            // with existing data and allow updates.
            showMessage('Edit Feature', 'This feature is for demonstration. In a full app, you would load the account details into the form for editing and then update the document.');
            console.log("Attempting to edit account:", accountId);
            // Example of how you might fetch and populate for editing:
            // const accountDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/smr_mardan_donation_accounts`, accountId));
            // if (accountDoc.exists()) {
            //     const data = accountDoc.data();
            //     document.getElementById('accountType').value = data.accountType;
            //     // ... populate other fields based on type and then show relevant fields
            // }
        };

        window.deleteDonationAccount = async function(accountId) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to delete donation accounts.');
                return;
            }
            // Using custom modal instead of confirm()
            showMessage('Confirm Deletion', 'Are you sure you want to delete this donation account? <br><br><button onclick="confirmDeleteDonationAccount(\'' + accountId + '\')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Yes, Delete</button> <button onclick="hideMessage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 ml-2">Cancel</button>');
        };

        window.confirmDeleteDonationAccount = async function(accountId) {
            hideMessage(); // Hide confirmation message
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/smr_mardan_donation_accounts`, accountId));
                showMessage('Success!', 'Donation account deleted successfully.');
            } catch (error) {
                console.error("Error deleting donation account:", error);
                showMessage('Error!', 'Issue deleting donation account: ' + error.message);
            }
        };


        // --- Admin Message to User Feature ---
        document.getElementById('adminMessageUserForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to send messages to users.');
                return;
            }

            const targetUserId = document.getElementById('targetUserId')?.value.trim(); // Null check added
            const messageSubject = document.getElementById('adminMessageSubject')?.value.trim(); // Null check added
            const messageContent = document.getElementById('adminMessageContent')?.value.trim(); // Null check added

            if (!messageSubject || !messageContent) {
                showMessage('Error', 'Please enter both subject and message content.');
                return;
            }

            try {
                if (targetUserId) {
                    // Send message to a specific user
                    await addDoc(collection(db, `artifacts/${appId}/users/${targetUserId}/admin_messages`), {
                        subject: messageSubject,
                        messageContent: messageContent,
                        sentByAdminId: userId,
                        sentAt: new Date().toISOString(),
                        status: 'New'
                    });
                    showMessage('Success!', `Message sent to user ID: ${targetUserId}.`);
                } else {
                    // Send message to all registered users
                    const membersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members`);
                    const membersSnapshot = await getDocs(membersColRef);
                    const batch = writeBatch(db); // Use batch writes for efficiency

                    membersSnapshot.forEach(memberDoc => {
                        const memberUserId = memberDoc.id; // Member's document ID is their user ID in this structure
                        const messageRef = doc(collection(db, `artifacts/${appId}/users/${memberUserId}/admin_messages`));
                        batch.set(messageRef, {
                            subject: messageSubject,
                            messageContent: messageContent,
                            sentByAdminId: userId,
                            sentAt: new Date().toISOString(),
                            status: 'New'
                        });
                    });
                    await batch.commit();
                    showMessage('Success!', 'Message sent to all registered users.');
                }
                document.getElementById('adminMessageUserForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error sending admin message:", error);
                showMessage('Error!', 'Issue sending message: ' + error.message);
            }
        });


        // --- Request Help Feature ---

        /**
         * Identifies the current user's member profile for help request submission.
         */
        window.identifySelfForHelp = async function() {
            if (!userId) {
                showMessage('Login Required', 'You must be logged in to request help.');
                return;
            }

            const helpIdentifyQueryElement = document.getElementById('helpIdentifyQuery');
            const helpIdentifyQuery = helpIdentifyQueryElement ? helpIdentifyQueryElement.value.trim() : ''; // Null check added
            const helpIdentifyResultDiv = document.getElementById('helpIdentifyResult');
            const helpRequestFormSection = document.getElementById('helpRequestFormSection');
            const identifiedHelpMemberName = document.getElementById('identifiedHelpMemberName');

            if (helpRequestFormSection) helpRequestFormSection.classList.add('hidden'); // Null check added
            identifiedHelpMemberId = null;
            if (identifiedHelpMemberName) identifiedHelpMemberName.innerText = ''; // Null check added

            if (!helpIdentifyQuery) {
                if (helpIdentifyResultDiv) helpIdentifyResultDiv.innerText = 'Please enter your registered Phone Number or Full Name.'; // Null check added
                return;
            }

            try {
                const membersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members`);
                let qPhone = query(membersColRef, where("phoneNumber", "==", helpIdentifyQuery));
                let qName = query(membersColRef, where("fullName", "==", helpIdentifyQuery));

                let querySnapshot = await getDocs(qPhone);
                if (querySnapshot.empty) {
                    querySnapshot = await getDocs(qName);
                }

                if (!querySnapshot.empty) {
                    const memberDoc = querySnapshot.docs[0];
                    identifiedHelpMemberId = memberDoc.id;
                    if (identifiedHelpMemberName) identifiedHelpMemberName.innerText = memberDoc.data().fullName; // Null check added
                    if (helpIdentifyResultDiv) helpIdentifyResultDiv.innerHTML = `<span class="text-green-700">Profile Found:</span> <span class="font-bold">${memberDoc.data().fullName}</span>`; // Null check added
                    if (helpRequestFormSection) helpRequestFormSection.classList.remove('hidden'); // Null check added
                    const issueExplanation = document.getElementById('issueExplanation');
                    const documentLink = document.getElementById('documentLink');
                    if (issueExplanation) issueExplanation.value = ''; // Null check added
                    if (documentLink) documentLink.value = ''; // Null check added
                } else {
                    if (helpIdentifyResultDiv) helpIdentifyResultDiv.innerHTML = `<span class="text-red-700">No matching registered member found.</span>`; // Null check added
                    if (helpRequestFormSection) helpRequestFormSection.classList.add('hidden'); // Null check added
                }

            } catch (error) {
                console.error("Error identifying self for help:", error);
                showMessage('Error!', 'Issue identifying your profile: ' + error.message);
            }
        };

        /**
         * Submits a new help request for the identified member.
         */
        window.submitHelpRequest = async function() {
            if (!userId) {
                showMessage('Login Required', 'You must be logged in to submit a help request.');
                return;
            }
            if (!identifiedHelpMemberId) {
                showMessage('Error', 'Please identify your profile first.');
                return;
            }

            const helpType = document.getElementById('helpType')?.value; // Null check added
            const issueExplanation = document.getElementById('issueExplanation')?.value.trim(); // Null check added
            const documentLink = document.getElementById('documentLink')?.value.trim(); // Null check added

            if (!helpType || !issueExplanation) {
                showMessage('Error', 'Please select help type and explain your issue.');
                return;
            }

            try {
                const assistanceRequestsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members/${identifiedHelpMemberId}/assistance_requests`);
                await addDoc(assistanceRequestsColRef, {
                    type: helpType,
                    issueDescription: issueExplanation,
                    documentLink: documentLink || null,
                    requestDate: new Date().toISOString(),
                    requestedByUserId: userId,
                    status: 'Under Review', // Default status for new requests
                    memberId: identifiedHelpMemberId // Add memberId to request for easier access in rendering
                });
                showMessage('Success!', 'Help request successfully submitted. The team will review it.');
                const helpRequestFormSection = document.getElementById('helpRequestFormSection');
                const helpIdentifyResult = document.getElementById('helpIdentifyResult');
                const helpIdentifyQuery = document.getElementById('helpIdentifyQuery');
                const helpTypeElement = document.getElementById('helpType');

                if (helpRequestFormSection) helpRequestFormSection.classList.add('hidden'); // Null check added
                if (helpIdentifyResult) helpIdentifyResult.innerText = ''; // Null check added
                if (helpIdentifyQuery) helpIdentifyQuery.value = ''; // Null check added
                if (helpTypeElement) helpTypeElement.value = ''; // Null check added
            } catch (error) {
                console.error("Error submitting help request:", error);
                showMessage('Error!', 'Issue submitting help request: ' + error.message);
            }
        };

        // --- Blood Request System ---

        /**
         * Handles blood request submission and finds matching donors.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('bloodRequestForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to request blood.');
                return;
            }

            const bloodRequestGroup = document.getElementById('bloodRequestGroup')?.value; // Null check added
            const bloodRequestCity = document.getElementById('bloodRequestCity')?.value.trim(); // Null check added
            const urgencyLevel = document.getElementById('urgencyLevel')?.value; // Null check added
            const hospital = document.getElementById('bloodRequestHospital')?.value.trim(); // Null check added
            const patientName = document.getElementById('bloodRequestPatientName')?.value.trim(); // Null check added
            const units = document.getElementById('bloodRequestUnits')?.value.trim(); // Null check added


            if (!bloodRequestGroup || !bloodRequestCity || !urgencyLevel) {
                showMessage('Error', 'Please fill all blood request details.');
                return;
            }

            try {
                // Add the blood request to a dedicated collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_blood_requests`), {
                    bloodGroup: bloodRequestGroup,
                    city: bloodRequestCity,
                    urgency: urgencyLevel,
                    hospital: hospital || null,
                    patientName: patientName || null,
                    units: units ? parseInt(units) : null,
                    requestedByUserId: userId,
                    requestDate: new Date().toISOString(),
                    status: 'Active' // Default status for new blood requests
                });
                showMessage('Success!', 'Blood request submitted. Searching for matching donors...');

                // Find matching donors
                const membersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members`);
                const q = query(membersColRef,
                    where("bloodGroup", "==", bloodRequestGroup),
                    where("status", "==", "Verified") // Only verified members can be donors
                );
                const querySnapshot = await getDocs(q);

                const donorsContainer = document.getElementById('donorsContainer');
                const noMatchingDonorsMessage = document.getElementById('noMatchingDonorsMessage');

                if (donorsContainer && noMatchingDonorsMessage) { // Null check added
                    donorsContainer.innerHTML = '';
                    if (querySnapshot.empty) {
                        noMatchingDonorsMessage.classList.remove('hidden');
                    } else {
                        noMatchingDonorsMessage.classList.add('hidden');
                        querySnapshot.forEach(doc => {
                            donorsContainer.innerHTML += renderMatchingDonorCard(doc.data());
                        });
                        showMessage('Matching Donors Found', 'Please contact the listed donors directly.');
                    }
                }
                document.getElementById('bloodRequestForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error with blood request:", error);
                showMessage('Error!', 'Issue with blood request: ' + error.message);
            }
        });

        // --- Samples Request System ---
        document.getElementById('addSampleRequestForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to request samples.');
                return;
            }

            const productName = document.getElementById('sampleProductName')?.value.trim(); // Null check added
            const numberOfDoses = document.getElementById('sampleNumberOfDoses')?.value.trim(); // Null check added
            const strength = document.getElementById('sampleStrength')?.value.trim(); // Null check added
            const form = document.getElementById('sampleForm')?.value.trim(); // Null check added
            const additionalDetails = document.getElementById('sampleAdditionalDetails')?.value.trim(); // Null check added

            if (!productName || !numberOfDoses) {
                showMessage('Error', 'Please enter product name and number of doses.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_sample_requests`), {
                    productName: productName,
                    numberOfDoses: parseInt(numberOfDoses), // Store as number
                    strength: strength || null,
                    form: form || null,
                    additionalDetails: additionalDetails || null,
                    requestedByUserId: userId,
                    requestDate: new Date().toISOString(),
                    status: 'Active' // Default status
                });
                showMessage('Success!', 'Sample request submitted. Other members can now see it.');
                document.getElementById('addSampleRequestForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error adding sample request:", error);
                showMessage('Error!', 'Issue adding sample request: ' + error.message);
            }
        });

        window.markSampleRequestFulfilled = async function(requestId) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to mark sample requests as fulfilled.');
                return;
            }
            showMessage('Confirm Fulfillment', 'Are you sure you want to mark this sample request as fulfilled? <br><br><button onclick="confirmMarkSampleRequestFulfilled(\'' + requestId + '\')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Yes, Fulfilled</button> <button onclick="hideMessage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 ml-2">Cancel</button>');
        };

        window.confirmMarkSampleRequestFulfilled = async function(requestId) {
            hideMessage(); // Hide confirmation message
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/smr_mardan_sample_requests`, requestId), {
                    status: 'Fulfilled',
                    fulfilledAt: new Date().toISOString(),
                    fulfilledByUserId: userId
                });
                showMessage('Success!', 'Sample request marked as fulfilled.');
            } catch (error) {
                console.error("Error marking sample request fulfilled:", error);
                showMessage('Error!', 'Issue marking sample request fulfilled: ' + error.message);
            }
        };

        window.deleteSampleRequest = async function(requestId) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to delete sample requests.');
                return;
            }
            showMessage('Confirm Deletion', 'Are you sure you want to delete this sample request? <br><br><button onclick="confirmDeleteSampleRequest(\'' + requestId + '\')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Yes, Delete</button> <button onclick="hideMessage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 ml-2">Cancel</button>');
        };

        window.confirmDeleteSampleRequest = async function(requestId) {
            hideMessage(); // Hide confirmation message
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/smr_mardan_sample_requests`, requestId));
                showMessage('Success!', 'Sample request deleted.');
            } catch (error) {
                console.error("Error deleting sample request:", error);
                showMessage('Error!', 'Issue deleting sample request: ' + error.message);
            }
        };


        // --- Doctor Visit Information (Public Posting) ---
        document.getElementById('addDoctorVisitForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to post doctor visit information.');
                return;
            }

            const doctorName = document.getElementById('doctorVisitName')?.value.trim(); // Null check added
            const doctorContactNumber = document.getElementById('doctorContactNumber')?.value.trim(); // Null check added
            const doctorAttendanceNumber = document.getElementById('doctorAttendanceNumber')?.value.trim(); // Null check added
            const visitingTime = document.getElementById('doctorVisitTime')?.value.trim(); // Null check added
            const visitDate = document.getElementById('doctorVisitDate')?.value; // Null check added
            const location = document.getElementById('doctorVisitLocation')?.value.trim(); // Null check added
            const notes = document.getElementById('doctorVisitNotes')?.value.trim(); // Null check added

            if (!doctorName || !visitingTime || !visitDate) {
                showMessage('Error', 'Please enter doctor name, visiting time, and date.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_doctor_visits`), {
                    doctorName: doctorName,
                    doctorContactNumber: doctorContactNumber || null,
                    doctorAttendanceNumber: doctorAttendanceNumber || null,
                    visitingTime: visitingTime,
                    visitDate: visitDate,
                    location: location || null,
                    notes: notes || null,
                    postedByUserId: userId,
                    createdAt: new Date().toISOString()
                });
                showMessage('Success!', 'Doctor visit information posted successfully.');
                document.getElementById('addDoctorVisitForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error adding doctor visit post:", error);
                showMessage('Error!', 'Issue adding doctor visit post: ' + error.message);
            }
        });

        window.deleteDoctorVisitPost = async function(postId) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to delete doctor visit posts.');
                return;
            }
            showMessage('Confirm Deletion', 'Are you sure you want to delete this doctor visit post? <br><br><button onclick="confirmDeleteDoctorVisitPost(\'' + postId + '\')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Yes, Delete</button> <button onclick="hideMessage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 ml-2">Cancel</button>');
        };

        window.confirmDeleteDoctorVisitPost = async function(postId) {
            hideMessage(); // Hide confirmation message
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/smr_mardan_doctor_visits`, postId));
                showMessage('Success!', 'Doctor visit post deleted.');
            } catch (error) {
                console.error("Error deleting doctor visit post:", error);
                showMessage('Error!', 'Issue deleting doctor visit post: ' + error.message);
            }
        };


        // --- Daily Travel Posts (Carpooling/Ride-Sharing) ---
        document.getElementById('travelType')?.addEventListener('change', function() { // Null check added
            const travelType = this.value;
            const availableSeatsField = document.getElementById('availableSeatsField');
            if (travelType === 'Offer Ride') {
                if (availableSeatsField) { // Null check added
                    availableSeatsField.classList.remove('hidden');
                    document.getElementById('availableSeats')?.setAttribute('required', 'true'); // Null check added
                }
            } else {
                if (availableSeatsField) { // Null check added
                    availableSeatsField.classList.add('hidden');
                    document.getElementById('availableSeats')?.removeAttribute('required'); // Null check added
                }
            }
        });

        document.getElementById('addTravelPostForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to post travel details.');
                return;
            }

            const travelType = document.getElementById('travelType')?.value; // Null check added
            const travelOrigin = document.getElementById('travelOrigin')?.value.trim(); // Null check added
            const travelDestination = document.getElementById('travelDestination')?.value.trim(); // Null check added
            const travelDate = document.getElementById('travelDate')?.value; // Null check added
            const travelTime = document.getElementById('travelTime')?.value; // Null check added
            const availableSeats = document.getElementById('availableSeats')?.value; // Null check added
            const travelContactNumber = document.getElementById('travelContactNumber')?.value.trim(); // Null check added
            const travelPurpose = document.getElementById('travelPurpose')?.value.trim(); // Null check added
            const travelNotes = document.getElementById('travelNotes')?.value.trim(); // Null check added

            if (!travelType || !travelOrigin || !travelDestination || !travelDate || !travelTime || !travelContactNumber) {
                showMessage('Error', 'Please fill all required travel details.');
                return;
            }
            if (travelType === 'Offer Ride' && (!availableSeats || parseInt(availableSeats) <= 0)) {
                showMessage('Error', 'Please enter valid number of available seats.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_travel_posts`), {
                    travelType: travelType,
                    travelOrigin: travelOrigin,
                    travelDestination: travelDestination,
                    travelDate: travelDate,
                    travelTime: travelTime,
                    availableSeats: travelType === 'Offer Ride' ? parseInt(availableSeats) : null,
                    travelContactNumber: travelContactNumber,
                    travelPurpose: travelPurpose || null,
                    travelNotes: travelNotes || null,
                    postedByUserId: userId,
                    createdAt: new Date().toISOString()
                });
                showMessage('Success!', 'Travel post added successfully. It will be visible for today.');
                document.getElementById('addTravelPostForm')?.reset(); // Null check added
                document.getElementById('availableSeatsField')?.classList.add('hidden'); // Null check added // Hide seats field after reset
            } catch (error) {
                console.error("Error adding travel post:", error);
                showMessage('Error!', 'Issue adding travel post: ' + error.message);
            }
        });


        // --- Volunteer Sign-Up System ---

        /**
         * Handles volunteer sign-up submission.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('volunteerSignUpForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to sign up as a volunteer.');
                return;
            }

            const volunteerName = document.getElementById('volunteerName')?.value.trim(); // Null check added
            const volunteerPhone = document.getElementById('volunteerPhone')?.value.trim(); // Null check added
            const selectedSkills = Array.from(document.querySelectorAll('input[name="volunteerSkill"]:checked')).map(cb => cb.value);

            if (!volunteerName || !volunteerPhone || selectedSkills.length === 0) {
                showMessage('Error', 'Please fill volunteer name, phone, and select at least one skill.');
                return;
            }

            try {
                // Check if volunteer already exists by phone number
                const volunteersColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_volunteers`);
                const q = query(volunteersColRef, where("phoneNumber", "==", volunteerPhone));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showMessage('Already Registered', 'A volunteer with this phone number is already registered.');
                    return;
                }

                await addDoc(volunteersColRef, {
                    fullName: volunteerName,
                    phoneNumber: volunteerPhone,
                    skills: selectedSkills,
                    registeredByUserId: userId,
                    createdAt: new Date().toISOString()
                });
                showMessage('Success!', 'You have successfully signed up as a volunteer!');
                document.getElementById('volunteerSignUpForm')?.reset(); // Null check added
                document.querySelectorAll('input[name="volunteerSkill"]:checked').forEach(cb => cb.checked = false); // Uncheck all
            } catch (error) {
                console.error("Error signing up volunteer:", error);
                showMessage('Error!', 'Issue signing up volunteer: ' + error.message);
            }
        });

        // --- Free Health Camps & Events Section ---

        /**
         * Handles adding a new event.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('addEventForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to add an event.');
                return;
            }

            const eventName = document.getElementById('eventName')?.value.trim(); // Null check added
            const eventDescription = document.getElementById('eventDescription')?.value.trim(); // Null check added
            const eventDate = document.getElementById('eventDate')?.value; // Null check added
            const eventLocation = document.getElementById('eventLocation')?.value.trim(); // Null check added
            const eventMapLink = document.getElementById('eventMapLink')?.value.trim(); // Null check added

            if (!eventName || !eventDescription || !eventDate || !eventLocation) {
                showMessage('Error', 'Please fill all event details.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_events`), {
                    eventName: eventName,
                    description: eventDescription,
                    eventDate: eventDate,
                    eventLocation: eventLocation,
                    mapLink: eventMapLink || null,
                    postedByUserId: userId,
                    createdAt: new Date().toISOString()
                });
                showMessage('Success!', 'Event successfully added.');
                document.getElementById('addEventForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error adding event:", error);
                showMessage('Error!', 'Issue adding event: ' + error.message);
            }
        });

        // --- Live Community Feed / Wall ---

        /**
         * Handles adding a new community post.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('addPostForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to post to the feed.');
                return;
            }

            const postContent = document.getElementById('postContent')?.value.trim(); // Null check added
            const postImageLink = document.getElementById('postImageLink')?.value.trim(); // Null check added

            if (!postContent) {
                showMessage('Error', 'Please enter content for your post.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_community_posts`), {
                    postContent: postContent,
                    imageLink: postImageLink || null,
                    postedByUserId: userId,
                    createdAt: new Date().toISOString()
                });
                showMessage('Success!', 'Post successfully added to community feed.');
                document.getElementById('addPostForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error adding post:", error);
                showMessage('Error!', 'Issue adding post: ' + error.message);
            }
        });

        // --- Chat / Message Admin Option ---

        /**
         * Handles sending a message to admin.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('messageAdminForm')?.addEventListener('submit', async (event) => { // Null check added
            event.preventDefault();

            if (!userId) {
                showMessage('Login Required', 'You must be logged in to send a message to admin.');
                return;
            }

            const messageSubject = document.getElementById('messageSubject')?.value.trim(); // Null check added
            const messageContent = document.getElementById('messageContent')?.value.trim(); // Null check added

            if (!messageSubject || !messageContent) {
                showMessage('Error', 'Please enter both subject and message content.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_admin_messages`), {
                    subject: messageSubject,
                    messageContent: messageContent,
                    senderId: userId,
                    sentAt: new Date().toISOString(),
                    status: 'New' // Admin would change this to 'Read', 'Resolved' etc.
                });
                showMessage('Success!', 'Message successfully sent to admin. They will review it shortly.');
                document.getElementById('messageAdminForm')?.reset(); // Null check added
            } catch (error) {
                console.error("Error sending message to admin:", error);
                showMessage('Error!', 'Issue sending message to admin: ' + error.message);
            }
        });

        // --- Emergency Alert Button (SOS System) ---

        /**
         * Sends an emergency alert with location (if available).
         */
        window.sendEmergencyAlert = async function() {
            if (!userId) {
                showMessage('Login Required', 'You must be logged in to send an emergency alert.');
                return;
            }

            const emergencyStatus = document.getElementById('emergencyStatus');
            if (emergencyStatus) emergencyStatus.innerText = 'Sending alert...'; // Null check added
            let locationData = 'Location not available';

            // Attempt to get geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    locationData = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;
                    console.log("Location obtained:", locationData);
                    await recordEmergencyAlert(locationData);
                }, (error) => {
                    console.error("Geolocation error:", error);
                    locationData = `Location access denied or unavailable: ${error.message}`;
                    recordEmergencyAlert(locationData); // Record alert even if location fails
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            } else {
                await recordEmergencyAlert(locationData); // Record alert if geolocation not supported
            }
        };

        /**
         * Records the emergency alert in Firestore.
         * @param {string} location - The location data string.
         */
        async function recordEmergencyAlert(location) {
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/smr_mardan_emergency_alerts`), {
                    alertedByUserId: userId,
                    location: location,
                    alertTime: new Date().toISOString(),
                    status: 'New' // Admin would change this to 'Resolved'
                });
                showMessage('Emergency Alert Sent!', 'Your emergency alert has been sent to the SMR MARDAN team. They will contact you shortly.');
                const emergencyStatus = document.getElementById('emergencyStatus');
                if (emergencyStatus) emergencyStatus.innerText = 'Alert sent successfully!'; // Null check added
            } catch (error) {
                console.error("Error recording emergency alert:", error);
                showMessage('Error!', 'Issue sending emergency alert: ' + error.message);
                const emergencyStatus = document.getElementById('emergencyStatus');
                if (emergencyStatus) emergencyStatus.innerText = 'Failed to send alert.'; // Null check added
            }
        }

        // --- Gemini API Integrations ---

        /**
         * Calls the Gemini API to generate text.
         * @param {string} prompt - The prompt for the LLM.
         * @returns {Promise<string>} The generated text.
         */
        async function callGeminiAPI(prompt) {
            const chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will automatically provide this at runtime

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API response structure unexpected:", result);
                    return "Could not generate response. Unexpected API structure.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "Error generating response. Please try again.";
            }
        }

        /**
         * Summarizes a member's donation impact using Gemini AI.
         */
        window.summarizeDonationImpact = async function() {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to use this feature.');
                return;
            }
            if (!currentAdminViewMemberId) {
                showMessage('Error', 'No member selected to summarize donations for.');
                return;
            }

            const summaryDiv = document.getElementById('donationImpactSummary');
            const summaryContent = document.getElementById('donationSummaryContent');
            const loadingIndicator = document.getElementById('donationSummaryLoading');

            if (summaryDiv) summaryDiv.classList.remove('hidden'); // Null check added
            if (summaryContent) summaryContent.innerText = ''; // Null check added
            if (loadingIndicator) loadingIndicator.classList.remove('hidden'); // Null check added


            try {
                const donationProofsColRef = collection(db, `artifacts/${appId}/public/data/smr_mardan_members/${currentAdminViewMemberId}/donation_proofs`);
                const proofsSnapshot = await getDocs(donationProofsColRef);

                let verifiedDonations = [];
                if (!proofsSnapshot.empty) {
                    proofsSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'Verified') {
                            verifiedDonations.push({
                                type: data.type,
                                date: data.date,
                                description: data.description
                            });
                        }
                    });
                }

                let prompt;
                if (verifiedDonations.length > 0) {
                    const donationDetails = verifiedDonations.map(d => `- Type: ${d.type}, Date: ${d.date}, Description: ${d.description}`).join('\n');
                    prompt = `A community member has made the following verified donations:\n${donationDetails}\n\nBased on these donations, provide a concise summary (2-3 sentences) of the impact of their contribution to the community. Focus on the positive effect of their generosity.`;
                } else {
                    prompt = `This community member has no verified donations. Please state that there is no recorded impact from donations.`;
                }

                const generatedText = await callGeminiAPI(prompt);
                if (summaryContent) summaryContent.innerText = generatedText; // Null check added


            } catch (error) {
                console.error("Error summarizing donation impact:", error);
                if (summaryContent) summaryContent.innerText = "Failed to generate summary."; // Null check added
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden'); // Null check added
            }
        };

        /**
         * Clarifies an assistance request using Gemini AI.
         * @param {string} memberId - The ID of the member.
         * @param {string} requestId - The ID of the assistance request.
         * @param {string} issueDescription - The description of the issue.
         */
        window.clarifyAssistanceRequest = async function(memberId, requestId, issueDescription) {
            if (!userId || !isAdminUser) {
                showMessage('Access Denied', 'You do not have permission to use this feature.');
                return;
            }

            const clarifyDiv = document.getElementById(`clarifyRequestSummary_${requestId}`);
            const clarifyContent = document.getElementById(`clarifyRequestContent_${requestId}`);
            const loadingIndicator = document.getElementById(`clarifyRequestLoading_${requestId}`);

            if (clarifyDiv) clarifyDiv.classList.remove('hidden'); // Null check added
            if (clarifyContent) clarifyContent.innerText = ''; // Null check added
            if (loadingIndicator) loadingIndicator.classList.remove('hidden'); // Null check added


            try {
                const prompt = `A community member has submitted an assistance request with the following issue description:\n"${issueDescription}"\n\nBased on this, provide a concise summary of the core issue (1-2 sentences) and suggest 2-3 clarifying questions an admin might ask to better understand the situation. Format as "Summary: [summary]. Questions: 1. [Q1]? 2. [Q2]?".`;
                const generatedText = await callGeminiAPI(prompt);
                if (clarifyContent) clarifyContent.innerText = generatedText; // Null check added
            } catch (error) {
                console.error("Error clarifying assistance request:", error);
                if (clarifyContent) clarifyContent.innerText = "Failed to clarify request."; // Null check added
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden'); // Null check added
            }
        };


        // --- Initialize on Window Load ---
        window.onload = initializeFirebaseAndAuth;

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

    </script>
</body>
</html>
